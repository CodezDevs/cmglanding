local a=false;local b=module("cfg/events/cfg_battleroyale")local c={location=1,amount=1}local d={}local e;local function f()return{gas={radius=0.0,coords=nil,isActive=false,blip=0,timeUntilNext={minutes=2,seconds=0}},data={plane=0,lootBoxes={},armourPlates={},timer=15,leaderboard={}},player={canExitPlane=false,isInWinnerScreen=false,hasJumped=false},players={}}end;local g=f()Citizen.CreateThread(function()for h=1,#b.locations do d[h]=b.locations[h].name end end)CMG.registerEventMenuItem("Battle Royal","CMG Battlegrounds",function()RageUI.Separator("Minimum Players: 5")RageUI.Separator("Maximum Players: 50")RageUI.List("Location",d,c.location,nil,{},true,function(i,j,k,l)if j then c.location=l end end,function()end)if not currentEvent.isActive then RageUI.ButtonWithStyle("Start Event",nil,{RightLabel="→→→"},true,function(i,j,k)if k then e=c.location;TriggerServerEvent("CMG:startEvent","Battle Royal","CMG Battlegrounds",5,50,{locationIndex=c.location,name=d[c.location]})end end)end end)local function m()if a then DrawRect(0.496,0.945,1.008,0.12,0,0,0,150)DrawRect(0.493,0.059,1.025,0.12,0,0,0,150)if CursorInArea(GetArea(0.493,0.944,0.14,0.074))then DrawRect(0.493,0.944,0.14,0.074,0,203,93,134)else DrawRect(0.493,0.944,0.14,0.074,0,180,93,134)end;if g.data.timer>0 then DrawAdvancedText(0.587,0.934,0.005,0.0028,0.971,tostring(g.data.timer),255,255,255,255,4,0)else DrawAdvancedText(0.587,0.934,0.005,0.0028,0.971,"JUMP",255,255,255,255,4,0)end;DrawAdvancedText(0.591,0.042,0.005,0.0028,0.993,"CMG BATTLEGROUNDS",255,255,255,255,6,0)end end;CMG.createThreadOnTick(m)local function n()if g.player.isInWinnerScreen then DrawRect(0.486,0.064,1.081,0.202,0,0,0,150)DrawAdvancedText(0.262,0.067,0.005,0.0028,0.96599999999999,"WINNER WINNER CHICKEN DINNER!",255,255,255,255,6,0)DrawRect(0.478,0.933,1.054,0.194,0,0,0,150)DrawAdvancedText(0.582,0.905,0.005,0.0028,0.96599999999999,"#1 "..CMG.getPlayerName(PlayerId()),255,255,255,255,6,0)if CursorInArea(GetArea(0.092,0.925,0.154,0.096))then DrawRect(0.092,0.925,0.154,0.096,100,0,0,174)else DrawRect(0.092,0.925,0.154,0.096,78,0,0,174)end;DrawAdvancedText(0.185,0.91,0.005,0.0028,0.971,"LEAVE",255,255,255,255,6,0)end end;CMG.createThreadOnTick(n)function func_handleClicks()if a then if CursorInArea(GetArea(0.493,0.944,0.14,0.074))then if IsControlJustPressed(1,329)or IsDisabledControlJustPressed(1,329)then if g.player.canExitPlane then PlaySound(-1,"SELECT","HUD_FRONTEND_DEFAULT_SOUNDSET",0,0,1)ClearPedTasks(PlayerPedId())TaskLeaveVehicle(PlayerPedId(),g.data.plane,64)SetEntityVisible(PlayerPedId(),true)g.player.hasJumped=true;SetTimeout(5000,function()DeleteEntity(g.data.plane)if currentEvent.isActive then for o,p in pairs(GetActivePlayers())do if p~=PlayerId()then NetworkConcealPlayer(p,false,0)SetEntityVisible(GetPlayerPed(p),true,true)end end end;local q=PlayerPedId()while HasPedGotWeapon(q,`GADGET_PARACHUTE`,false)do local r=GetEntityHeightAboveGround(q)if r>10.0 and r<250.0 and IsPedInParachuteFreeFall(q)then drawNativeNotification("Press ~INPUT_PARACHUTE_DEPLOY~ to deploy your parachute.")end;Citizen.Wait(0)end end)setCursor(0)a=false;inGUICMG=false;CMG.showUI()end end end end;if g.player.isInWinnerScreen then if CursorInArea(GetArea(0.092,0.925,0.154,0.096))then if IsControlJustPressed(1,329)or IsDisabledControlJustPressed(1,329)then PlaySound(-1,"SELECT","HUD_FRONTEND_DEFAULT_SOUNDSET",0,0,1)setCursor(0)g.player.isInWinnerScreen=false;inGUICMG=false;a=false;g=f()CMG.showUI()end end end end;CMG.createThreadOnTick(func_handleClicks)RegisterNetEvent("CMG:syncLootboxesTable",function(s,t)g.data.lootBoxes=table.copy(b.lootBoxes[t])g.data.armourPlates=table.copy(b.armourPlates[t])CMG.loadModel(`prop_box_ammo03a`)for u,v in pairs(g.data.lootBoxes)do if#(v.coords-g.gas.coords)<g.gas.radius/2 then g.data.lootBoxes[u].areaId="cmgbr_lootbox_"..u;tvRP.setNamedBlip("cmgbr_lootbox_"..u,v.coords.x,v.coords.y,v.coords.z,478,1,"Lootbox",0.5)local w=function(x)if g.data.lootBoxes[x.box]then if g.data.lootBoxes[x.box].entity==nil then g.data.lootBoxes[x.box].entity=CreateObject(`prop_box_ammo03a`,v.coords,false,false,false)DecorSetInt(g.data.lootBoxes[x.box].entity,"lootid",s[x.box])SetEntityHeading(g.data.lootBoxes[x.box].entity,10.0)PlaceObjectOnGroundProperly(g.data.lootBoxes[x.box].entity)FreezeEntityPosition(g.data.lootBoxes[x.box].entity,true)end else print(string.format("[CMG] lootbox with ID: %s is nil",x.box))end end;local y=function(x)if g.data.lootBoxes[x.box]then if g.data.lootBoxes[x.box].entity then if DoesEntityExist(g.data.lootBoxes[x.box].entity)then DeleteEntity(g.data.lootBoxes[x.box].entity)g.data.lootBoxes[u].entity=nil end end end end;local z=function()end;CMG.createArea("cmgbr_lootbox_"..u,v.coords,200.0,6,w,y,z,{box=u})end end;SetModelAsNoLongerNeeded(`prop_box_ammo03a`)CMG.loadModel(`prop_armour_pickup`)for u,v in pairs(g.data.armourPlates)do if#(v.coords-g.gas.coords)<g.gas.radius/2 then tvRP.setNamedBlip("cmgbr_armour_"..u,v.coords.x,v.coords.y,v.coords.z,175,1,"Lootbox",0.5)local A=function(B)if g.data.armourPlates[B.plateId]then if g.data.armourPlates[B.plateId].entity==nil then g.data.armourPlates[B.plateId].entity=CreateObject(`prop_armour_pickup`,v.coords,false,false,false)SetEntityHeading(g.data.armourPlates[B.plateId].entity,10.0)PlaceObjectOnGroundProperly(g.data.armourPlates[B.plateId].entity)FreezeEntityPosition(g.data.armourPlates[B.plateId].entity,true)end else print(string.format("[CMG Events] body armour with ID of %s is nil in table (onEnter)",B.plateId))end end;local C=function(B)if g.data.armourPlates[B.plateId]then if g.data.armourPlates[B.plateId].entity then if DoesEntityExist(g.data.armourPlates[B.plateId].entity)then DeleteEntity(g.data.armourPlates[B.plateId].entity)g.data.armourPlates[B.plateId].entity=nil end end else print(string.format("[CMG Events] body armour with ID of %s is nil in table (onLeave)",B.plateId))end end;local D=function(B)if g.data.armourPlates[B.plateId]then if B.distance<=1.5 then local E=g.data.armourPlates[B.plateId].coords;CMG.DrawText3D(vector3(E.x,E.y,E.z-0.5),"Press [E] to pickup armour.",0.2)if IsControlJustPressed(0,51)then TriggerServerEvent("CMG:removeArmourPlate",B.plateId)SetPedComponentVariation(PlayerPedId(),9,15,3,0)end end end end;CMG.createArea("cmgbr_armour_"..u,v.coords,200.0,6,A,C,D,{plateId=u})g.data.armourPlates[u].areaId="cmgbr_armour_"..u end end;SetModelAsNoLongerNeeded(`prop_armour_pickup`)end)RegisterNetEvent("CMG:removeLootBox",function(F)tvRP.removeArea("cmgbr_lootbox_"..F)tvRP.removeNamedBlip("cmgbr_lootbox_"..F)if g.data.lootBoxes[F].entity then if DoesEntityExist(g.data.lootBoxes[F].entity)then DeleteEntity(g.data.lootBoxes[F].entity)g.data.lootBoxes[F].entity=nil end end;g.data.lootBoxes[F]=nil end)RegisterNetEvent("CMG:removeArmourPlateCl",function(G)tvRP.removeArea("cmgbr_armour_"..G)tvRP.removeNamedBlip("cmgbr_armour_"..G)if g.data.armourPlates[G]then if g.data.armourPlates[G].entity then if DoesEntityExist(g.data.armourPlates[G].entity)then DeleteEntity(g.data.armourPlates[G].entity)g.data.armourPlates[G].entity=nil end end;g.data.armourPlates[G]=nil end end)RegisterNetEvent("CMG:startBattlegrounds",function(H)e=H;CMG.startGas(b.locations[e].gas.initalRadius,b.locations[e].gas.centre)DoScreenFadeOut(1500)Wait(1500)currentEvent.eventName="Battle Royale"globalHideUi=true;TriggerEvent("CMG:showHUD",false)TriggerEvent("chat:clear")CMG.stopEventSequence(true)CMG.giveWeapons({["GADGET_PARACHUTE"]={2}})SetEntityCoords(PlayerPedId(),b.locations[e].planeStart)CMG.loadModel(`titan`)for o,p in pairs(GetActivePlayers())do if p~=PlayerId()then NetworkConcealPlayer(p,true,0)SetEntityVisible(GetPlayerPed(p),false,false)end end;local I=CMG.spawnVehicle(`titan`,b.locations[e].planeStart,b.locations[e].planeHeading,false,false,true)SetModelAsNoLongerNeeded(`titan`)SetEntityCollision(I,false,true)SetVehicleEngineOn(I,true,true,false)SetPlaneTurbulenceMultiplier(I,0.0)CMG.loadModel(`s_m_m_pilot_02`)local J=CreatePedInsideVehicle(I,1,`s_m_m_pilot_02`,-1,false,true)SetModelAsNoLongerNeeded(`s_m_m_pilot_02`)Wait(500)SetPedIntoVehicle(PlayerPedId(),I,-2)SetPedKeepTask(J,true)ActivatePhysics(I)SetVehicleEngineHealth(I,1000.0)SetVehicleBodyHealth(I,1000.0)SetVehicleDeformationFixed(I)SetVehicleForwardSpeed(I,60.0)SetHeliBladesFullSpeed(I)SetVehicleEngineOn(I,true,true,false)ControlLandingGear(I,3)OpenBombBayDoors(I)SetEntityProofs(I,true,true,true,true,true,true,true,true)SetEntityInvincible(I,true)TaskVehicleDriveToCoord(J,I,b.locations[e].planeEnd+vector3(0.0,0.0,500.0),60.0,0,`titan`,262144,15.0,-1.0)SetEntityVisible(PlayerPedId(),false)setCursor(1)g.data.plane=I;a=not a;inGUICMG=not inGUICMG;Wait(1500)DoScreenFadeIn(1500)Citizen.CreateThread(function()while not g.player.canExitPlane and currentEvent.isActive do g.data.timer=g.data.timer-1;Wait(1000)end end)SetTimeout(15000,function()if currentEvent.isActive then g.player.canExitPlane=true end end)end)RegisterNetEvent("CMG:winBattleRoyale",function()globalHideUi=true;TriggerEvent("CMG:showHUD",false)TriggerEvent("chat:clear")g.player.isInWinnerScreen=true;inGUICMG=true;setCursor(1)TriggerEvent('playSound:questcomplete')end)CMG.registerEventCleanupHandler("CMG Battlegrounds",function()currentEvent.isActive=false;for u,v in pairs(g.data.lootBoxes)do tvRP.removeArea(v.areaId)tvRP.removeNamedBlip(v.areaId)if DoesEntityExist(v.entity)then DeleteEntity(v.entity)end end;for u,v in pairs(g.data.armourPlates)do tvRP.removeArea(v.areaId)tvRP.removeNamedBlip(v.areaId)if DoesEntityExist(v.entity)then DeleteEntity(v.entity)end end;RemoveBlip(g.gas.blip)if not g.player.isInWinnerScreen then inGUICMG=false;a=false;setCursor(0)g=f()end end)function CMG.startGas(K,E)g.gas.coords=E;g.gas.radius=K;g.gas.blip=AddBlipForRadius(E,K/2)SetBlipColour(g.gas.blip,1)SetBlipAlpha(g.gas.blip,155)g.gas.isActive=not g.gas.isActive end;function CMG.changeGasRadius(K)SendNUIMessage({transactionType="br-gas"})g.gas.timeUntilNext={minutes=2,seconds=0}CMG.announceMpBigMsg("~r~GAS MOVING","The gas is closing in!",5000)Wait(4000)Citizen.CreateThread(function()while g.gas.isActive and g.gas.radius>tonumber(K)and currentEvent.isActive do g.gas.radius=g.gas.radius-g.gas.radius*0.008*GetFrameTime()RemoveBlip(g.gas.blip)g.gas.blip=AddBlipForRadius(g.gas.coords,g.gas.radius/2)SetBlipColour(g.gas.blip,1)SetBlipAlpha(g.gas.blip,155)Wait(0)end end)end;CMG.createThreadOnTick(function()if g.gas.isActive then local K=g.gas.radius;if K>=1800.0 then K=K-17.5 elseif K>=1400.0 then K=K-15.0 elseif K>=1000 then K=K-12.5 elseif K>=600 then K=K-10.0 elseif K>=250 then K=K-5.0 end;DrawMarker(1,g.gas.coords.x,g.gas.coords.y,0.0,0.0,0.0,0.0,1.0,1.0,1.0,K,K,6000.0,255,0,0,155,false,false,2,false,nil,nil,false)end end)local L={[1]="1st",[2]="2nd",[3]="3rd"}local M={[1]=4,[2]=3,[3]=2}local N={[1]="~HUD_COLOUR_GOLD~",[2]="~HUD_COLOUR_SILVER~",[3]="~HUD_COLOUR_BRONZE~"}CMG.createThreadOnTick(function()if currentEvent.isActive and currentEvent.eventName=="Battle Royale"then for h=1,3 do if g.data.leaderboard[h]then DrawGTATimerBar(N[h]..L[h].." "..g.data.leaderboard[h].name,N[h]..g.data.leaderboard[h].kills,M[h]+1)end end;DrawGTATimerBar("~y~GAS:~w~",string.format("~y~%02d:%02d",g.gas.timeUntilNext.minutes,g.gas.timeUntilNext.seconds),2)end end)Citizen.CreateThread(function()while true do if g.gas.isActive then if g.gas.timeUntilNext.seconds>0 then g.gas.timeUntilNext.seconds=g.gas.timeUntilNext.seconds-1 else if g.gas.timeUntilNext.seconds==0 and g.gas.timeUntilNext.minutes==0 then CMG.changeGasRadius(g.gas.radius-400)else g.gas.timeUntilNext.seconds=59;g.gas.timeUntilNext.minutes=g.gas.timeUntilNext.minutes-1 end end end;Wait(1000)end end)local function O()local P=sortedKeys(g.players,function(Q,R)return g.players[Q].kills>g.players[R].kills end)for h=1,3 do if g.players[P[h]]then g.players[P[h]].leaderboardPos=h;g.data.leaderboard[h]=g.players[P[h]]end end end;RegisterNetEvent("CMG:addBRKill",function(p,S)if g.players[p]then g.players[p].kills=g.players[p].kills+1 else g.players[p]={source=p,name=S,kills=1}end;O()end)RegisterNetEvent("CMG:removePlayerFromBR",function(T)if g.players[T]then local p=table.copy(g.players[T])g.players[T]=nil;if p.leaderboardPos then g.data.leaderboard[p.leaderboardPos]=nil;O()end end end)Citizen.CreateThread(function()while true do if g.gas.isActive and g.player.hasJumped and not IsPedInParachuteFreeFall(PlayerPedId())and GetPedParachuteState(PlayerPedId())<=2 and currentEvent.isActive then if#(CMG.getPlayerCoords().xy-g.gas.coords.xy)>g.gas.radius/2.0 then drawNativeText("~r~You are in the gas. Get to the safe zone before you suffocate.")local J=PlayerPedId()local U=GetEntityHealth(J)SetEntityHealth(J,U-1)end end;Wait(500)end end)
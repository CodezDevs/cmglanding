local a=module("cfg/cfg_streetracing")local b=1;local c=1;local d=false;local e=100;local f=false;local g=false;local h=0;local i={}local j={}local k=0;local l=vector2(0.015,0.725)local m=false;local n=2;local o=false;local p=false;local q=false;local r=""local s=""local t="The race currently ~r~is NOT joinable"local u=false;local v=false;local w=false;local x=false;local y=-1;local z=-1;local A=0;local B=0;local C=false;local D=false;local E;local F=false;local G=0.0;local H=0;local I=0;local J=0;local K=""local L=""local M=0;local N=false;local O={}local P=-1;local Q={state=0,index=0,checkpoint=0,gameID=0,raceID=0,playerMenuState=1,vehicle=0}local R={host=false,MenuStage=0,startDelay=0,startDelayIndex=1,joinableIndex=2,collisonIndex=1,currentCollisionOption=1,currentJoinableOption=1,options={joinable={"~g~Yes~s~","~r~No~s~"},startDelay={20,30,45,60},collision={"~g~Enabled~s~","~r~Disabled~s~"}},players={}}RMenu.Add('street_race','host',RageUI.CreateMenu("","",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight(),"cmg_streetracingui","cmg_streetracingui"))RMenu:Get('street_race','host'):SetSubtitle(string.format("~b~%s",a.races[b].ufName))RMenu.Add('street_race','kickPlayers',RageUI.CreateSubMenu(RMenu:Get('street_race','host'),"","~b~Select a player to kick them from the race",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight(),"cmg_streetracingui","cmg_streetracingui"))RMenu:Get('street_race','host').Closable=false;RMenu.Add('street_race','player',RageUI.CreateMenu("","",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight(),"cmg_streetracingui","cmg_streetracingui"))RMenu:Get('street_race','player'):SetSubtitle(string.format("~b~%s",a.races[b].ufName))RMenu.Add('street_race','finish',RageUI.CreateMenu("","",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight(),"cmg_streetracingui","cmg_streetracingui"))RMenu:Get('street_race','finish'):SetSubtitle("You Finished!")RMenu:Get('street_race','finish').Closable=false;local function S(T)local U=false;for V=0,13,1 do if GetVehicleClass(GetVehiclePedIsIn(CMG.getPlayerPed(),false))==V then U=true;break end end;if b~=nil then if Q.state==2 then if T then tvRP.notify('~r~You are already in a race!')end elseif not IsPedInAnyVehicle(CMG.getPlayerPed(),false)and U then tvRP.notify('~r~You cannot race without a vehicle')d=false else print("triggering")TriggerServerEvent('CMG:streetRacingToggleView',T,b)end else tvRP.notify("~y~Exit the marker, wait a few seconds and then try again")end end;local function W(X,Y,Z,_)ClearTimecycleModifier()local a0={handle=Scaleform("MP_CELEBRATION"),handle2=Scaleform("MP_CELEBRATION_BG"),handle3=Scaleform("MP_CELEBRATION_FG")}for a1,a2 in pairs(a0)do a2.RunFunction("CLEANUP",{"WINNER"})a2.RunFunction("CREATE_STAT_WALL",{"WINNER","HUD_COLOUR_BLACK","70.0"})a2.RunFunction("SET_PAUSE_DURATION",{function()ScaleformMovieMethodAddParamFloat(2.5)end})if I~=nil and Z~="DNF"then if I~=0 then local a3=Z-I;if a3>0 then a2.RunFunction("ADD_TIME_TO_WALL",{"WINNER",Z,"CELEB_TIME",a3})else a2.RunFunction("ADD_TIME_TO_WALL",{"WINNER",Z,"CELEB_TIME"})end else a2.RunFunction("ADD_TIME_TO_WALL",{"WINNER",Z,"CELEB_TIME"})end else a2.RunFunction("ADD_TIME_TO_WALL",{"WINNER",Z,"CELEB_TIME"})end;a2.RunFunction("ADD_POSITION_TO_WALL",{"WINNER",Y,"1ST",false,false})if _~=0 then a2.RunFunction("ADD_CASH_TO_WALL",{"WINNER",_,true})end;a2.RunFunction("ADD_WINNER_TO_WALL",{"WINNER","CELEB_WINNER",X,"",0,false,"",false})a2.RunFunction("ADD_BACKGROUND_TO_WALL",{"WINNER",75,0})a2.RunFunction("SHOW_STAT_WALL",{"WINNER"})end;return a0.handle,a0.handle2,a0.handle3 end;local function a4()Citizen.CreateThread(function()local a5=12;repeat Wait(1000)a5=a5-1 until a5==0;w=false end)end;RegisterNetEvent("CMG:streetRacingToggleHostMenu",function(T,a6,a7)if a6~=nil then Q.gameID=a6;Q.raceID=a7 end;if T then R.host=true;Q.index=1 end;if R.MenuStage==0 then R.MenuStage=1 end;RMenu:Get('street_race','host'):SetSubtitle(string.format("~b~%s",a.races[b].ufName))RageUI.Visible(RMenu:Get('street_race','deferral'),false)RageUI.Visible(RMenu:Get('street_race','host'),T)d=T end)RegisterNetEvent("CMG:streetRacingTogglePlayerMenu",function(T,a8)if T then h=a8 else betAmout=0 end;if T then R.host=false end;RMenu:Get('street_race','player'):SetSubtitle(string.format("~b~%s",a.races[b].ufName))RageUI.Visible(RMenu:Get('street_race','player'),T)end)RegisterNetEvent("CMG:streetRacingToggleFinishedMenu",function(T)RageUI.Visible(RMenu:Get('street_race','finish'),T)end)RegisterNetEvent("CMG:streetRacingConfirmPayment",function(a9)if a9 then g=true;if R.host then TriggerServerEvent("CMG:streetRacingSetBetAmount",Q.gameID,h)R.MenuStage=2;Q.state=1;Q.index=1 end else tvRP.notify("~r~Failed to process payment")end;p=false end)RegisterNetEvent("CMG:streetRacingReturnPlayerIndex",function(aa,ab,ac)Q.index=aa;Q.state=1;Q.gameID=ab;Q.raceID=ac;TriggerEvent("CMG:streetRacingLoadRace")end)RegisterNetEvent("CMG:streetRacingLoadRace",function()j={}i={}Q.checkpoint=1;Q.vehicle=GetVehiclePedIsIn(CMG.getPlayerPed(),false)for V=1,#a.races[Q.raceID].checkpoints,1 do local ad=a.races[Q.raceID].checkpoints[V]i[V]=AddBlipForCoord(ad.x,ad.y,ad.z)SetBlipColour(i[V],5)SetBlipAsShortRange(i[V],true)ShowNumberOnBlip(i[V],V)end;for V=1,#a.races[Q.raceID].checkpoints,1 do j[V]={}j[V].vector=a.races[Q.raceID].checkpoints[V]j[V].checkpoint=nil end;SetWaypointOff()SetBlipRoute(i[1],true)SetBlipRouteColour(i[1],5)end)RegisterNetEvent("CMG:streetRacingUpdateIndex",function(ae)Q.index=ae end)AddEventHandler("CMG:streetRacingShowCountdownTimer",function(Z)CMG.showCountdownTimer(Z)end)RegisterNetEvent("CMG:streetRacingResetClient",function()g=false;R={host=false,MenuStage=0,startDelay=0,startDelayIndex=1,joinableIndex=2,collisonIndex=1,currentCollisionOption=1,options={joinable={"~g~Yes~s~","~r~No~s~"},startDelay={20,30,45,60},collision={"~g~Enabled~s~","~r~Disabled~s~"}},players={}}h=0;k=0;q=false;m=false;Q.state=0;Q.index=0;Q.checkpoint=0;Q.vehcile=0;Wait(500)Q.gameID=0;Q.raceID=0;Q.playerMenuState=1;RageUI.Visible(RMenu:Get('street_race','player'),false)RageUI.Visible(RMenu:Get('street_race','host'),false)RageUI.Visible(RMenu:Get('street_race','finish'),false)RageUI.CloseAll()S(false)P=-1;u=false;v=false;C=false;w=false;F=false;x=false;A=0;N=false;B=0;y=-1;z=-1;D=false;DeleteEntity(E)h=0;for V=1,#i,1 do RemoveBlip(i[V])end;i={}for V=1,#j,1 do DeleteCheckpoint(j[V].checkpoint)end;O={}j={}RageUI.CloseAll()SetWaypointOff()d=false;p=false;FreezeEntityPosition(GetVehiclePedIsIn(CMG.getPlayerPed(),false),false)Citizen.Wait(20)end)RegisterNetEvent("CMG:streetRacingHostStarted",function(af)m=true;k=GetGameTimer()+af end)RegisterNetEvent("CMG:streetRacingReturnBetAmount",function(ag)h=ag end)RegisterNetEvent("CMG:streetRacingDisableCollision",function(ah)O=ah end)RegisterNetEvent("CMG:streetRacingHostPlayerListUpdate",function(ai)R.players=ai end)RegisterNetEvent("CMG:streetRacingReturnScaleformUpdate",function(aj,ak)r=aj;s=ak end)RegisterNetEvent("CMG:streetRacingStartDNFTimer",function(al)P=GetGameTimer()+al end)RegisterNetEvent("CMG:streetRacingFinalScaleform",function(X,Y,Z,_)Q.state=4;FreezeEntityPosition(GetVehiclePedIsIn(CMG.getPlayerPed(),true))SetEntityHeading(CMG.getPlayerPed(),a.races[Q.raceID].startHeading)SetEntityCoords(GetVehiclePedIsIn(CMG.getPlayerPed(),false),a.races[Q.raceID].startPositions[Q.index].x,a.races[Q.raceID].startPositions[Q.index].y,a.races[Q.raceID].startPositions[Q.index].z,false,false,false,true)RageUI.Visible(RMenu:Get('street_race','finish'),false)Citizen.Wait(150)SetDrawOrigin(0,0,0,0)local am,an,ao=W(X,Y,Z,_)if not w then w=true;a4()end;while w do Wait(0)HideHudAndRadarThisFrame()DrawScaleformMovieFullscreenMasked(an.Handle,ao.Handle,255,255,255,255)am.Render2D()end;TriggerEvent("CMG:streetRacingResetClient")end)RegisterNetEvent("CMG:streetRacingReturnTopTime",function(ap,aq,ar)if ap==b then J=aq;K=ar;if GetResourceKvpInt(tostring(ap))~=nil then H=GetResourceKvpInt(tostring(ap))end;if J==nil then J=0 end end end)RegisterNetEvent("CMG:streetRacingReturnPosition",function(as)if as==1 then L="1st"elseif as==2 then L="2nd"elseif as==3 then L="3rd"else L=tostring(as).."th"end end)Citizen.CreateThread(function()while true do local at=GetEntityCoords(CMG.getPlayerPed())local au=1000000;for V=1,#a.races,1 do local f=#(at-a.races[V].start)if f<au then b=V;au=f end end;e=#(at-a.races[b].start)if e<4.0 and not d then d=true;if b~=c then c=b;TriggerServerEvent("CMG:streetRacingGetTopTrackTime",b)end;S(true)elseif e>5.0 and d and(Q.state==2 or Q.state==0)then d=false;S(false)if R.host and Q.state==0 then TriggerServerEvent("CMG:streetRacingClearGame",b)TriggerServerEvent('CMG:streetRacingToggleView',false,b)h=0;R.MenuStage=0;Q.gameID=0;Q.raceID=0;Q.index=0;h=0;R.host=false end end;if Q.state==1 then RageUI.Visible(RMenu:Get('street_race','deferral'),false)RageUI.Visible(RMenu:Get('street_race','host'),true)end;local av;if e<350 or Q.state==1 then av=100 else av=1500 end;Wait(av)end end)Citizen.CreateThread(function()while true do if e<=20 and not d then TriggerServerEvent("CMG:streetRacingUpdateMarkerScaleform",b)end;Wait(10000)end end)Citizen.CreateThread(function()while true do local av=500;DrawMarker(a.races[b].markType,a.races[b].start.x,a.races[b].start.y,a.races[b].start.z-1.0,0,0,0,0,0,0,1.0001*a.races[b].sizeMult,1.0001*a.races[b].sizeMult,1.0001*a.races[b].sizeMult/2.4,a.races[b].markRGBA[1],a.races[b].markRGBA[2],a.races[b].markRGBA[3],a.races[b].markRGBA[4],0,0,0,0)if e<=200 and not d then av=0;local aw=8;local ax=vector3(a.races[b].start.x,a.races[b].start.y,a.races[b].start.z-1.5)local ay=vector3(a.races[b].start.x,a.races[b].start.y,a.races[b].start.z-4.0)local az=GetEntityCoords(CMG.getPlayerPed())-ax;if az.x>0 then local aA=math.atan(az.y/az.x)rotation=270-aA*180/math.pi elseif az.x<0 then local aA=math.atan(az.y/-az.x)rotation=aA*180/math.pi+90 end;local aB=Scaleform("mp_mission_name_freemode")aB.RunFunction("SET_MISSION_INFO",{r,a.races[b].name,"","","","",s,"0","",""})aB.Render3D(ax,vector3(0,0,rotation),vector2(aw,aw))end;if e<=200 then av=0 end;Wait(av)end end)RageUI.CreateWhile(1,RMenu:Get('street_race','host'),nil,function()RageUI.IsVisible(RMenu:Get('street_race','host'),true,false,true,function()if Q.raceID~=0 and Q.gameID~=0 then if R.MenuStage==1 then RageUI.ButtonWithStyle("Wager Amount","Select to set wager amount",{RightLabel="→→→"},true,function(aC,aD,aE)if aE then AddTextEntry("FMMC_MPM_NA","Set wager amount")DisplayOnscreenKeyboard(6,"FMMC_MPM_NA","","","","","",30)local aF=true;while aF do HideHudAndRadarThisFrame()if UpdateOnscreenKeyboard()==3 then aF=false elseif UpdateOnscreenKeyboard()==1 then local aG=0;local aG=GetOnscreenKeyboardResult()if string.len(aG)>0 then argString=aG;aF=false;if argString==""or argString==" "then tvRP.notify("~r~Input something")elseif argString==nil then aF=true;tvRP.notify("~r~Input a number!")DisplayOnscreenKeyboard(6,"FMMC_MPM_NA","","","","","",30)elseif tonumber(argString)<0 then tvRP.notify("~r~Value cannot be negative!")else argString=tonumber(argString)h=argString;if h<0 then h=0 end end else DisplayOnscreenKeyboard(false,"FMMC_MPM_NA","","","","","",30)end elseif UpdateOnscreenKeyboard()==2 then aF=false end;Wait(0)end end end)RageUI.Separator("Wager set to: £"..tostring(h):reverse():gsub("%d%d%d","%1,"):reverse():gsub("^,",""))RageUI.ButtonWithStyle("Pay and Create Game","Select to pay and create the game",{RightLabel="→→→"},true,function(aC,aD,aE)if aE then TriggerServerEvent("CMG:streetRacingTakeMoney",h,b)end end)elseif R.MenuStage==2 then RageUI.Separator("Wager was set to: £"..tostring(h):reverse():gsub("%d%d%d","%1,"):reverse():gsub("^,",""))local aH=J/1000.0;if aH==0 then RageUI.Separator("~w~Track Record: ~g~--:--.---. By: N/A")else local aI=math.floor(aH/60.0)aH=aH-60.0*aI;RageUI.Separator(string.format("~w~Track Record: ~g~%02d:%05.2f. By: %s",aI,aH,K))end;local aJ=H/1000.0;if aJ==0 then RageUI.Separator("~w~Personal Best: ~b~--:--.---")else local aK=math.floor(aJ/60.0)aJ=aJ-60.0*aK;RageUI.Separator(string.format("~w~Personal Best: ~b~%02d:%05.2f",aK,aJ))end;RageUI.Button("Cancel Race","Select to cancel the race.",true,function(aC,aD,aE)if aE then R.MenuStage=98 end end)RageUI.List("Make the race joinable?",R.options.joinable,R.joinableIndex,"Choose option and then select to change value, "..t,{},true,function(aC,aD,aE,aL)if aD then if R.joinableSelectedOption~=R.joinableIndex then R.joinableSelectedOption=R.joinableIndex;if R.joinableIndex==1 then TriggerServerEvent("CMG:streetRacingUpdateRaceJoinable",Q.raceID,true)t="The race currently ~g~is joinable"else TriggerServerEvent("CMG:streetRacingUpdateRaceJoinable",Q.raceID,false)t="The race currently ~r~is NOT joinable"end end end;R.joinableIndex=aL end)RageUI.ButtonWithStyle("Kick Players","Select to open the player list",{RightLabel="→→→"},true,function(aC,aD,aE)if aE and k==0 then R.MenuStage=99 end end)RageUI.List("Player Collision",R.options.collision,R.collisonIndex,"Player Collision is "..R.options.collision[R.collisonIndex],{},true,function(aC,aD,aE,aL)if aD and k==0 then if R.collisonIndex~=R.currentCollisionOption then R.currentCollisionOption=R.collisonIndex;local aM=R.collisonIndex==1 and true or false;TriggerServerEvent("CMG:streetRacingUpdateRaceCollision",Q.gameID,aM)end end;if k==0 then R.collisonIndex=aL end end)RageUI.List("Countdown",R.options.startDelay,R.startDelayIndex,"Set the countdown duration after you start the race",{},true,function(aC,aD,aE,aL)R.startDelayIndex=aL end)RageUI.ButtonWithStyle("Start Race","Select to start the race with the set countdown",{RightLabel="→→→"},true,function(aC,aD,aE)if aE then TriggerServerEvent("CMG:streetRacingStartRace",Q.gameID,R.options.startDelay[R.startDelayIndex]*1000)TriggerEvent("CMG:streetRacingLoadRace")end end)elseif R.MenuStage==98 then RageUI.Separator("Are you sure you want to cancel the race?")RageUI.Button("No","No",true,function(aC,aD,aE)if aE then R.MenuStage=2 end end)RageUI.Button("Yes","Cancel the Race",true,function(aC,aD,aE)if aE and not p then p=true;TriggerServerEvent("CMG:streetRacingCancelGame",Q.gameID)TriggerServerEvent("CMG:streetRacingClearGame",b)TriggerServerEvent('CMG:streetRacingToggleView',false,b)h=0;R.MenuStage=0;h=0;R.host=false end end)RageUI.ButtonWithStyle("Back","Go Back",{RightLabel="←←←"},true,function(aC,aD,aE)if aE then R.MenuStage=2 end end)elseif R.MenuStage==99 then for V=2,#R.players.temp,1 do RageUI.Button(R.players.name[V],string.format("TempID: %s. PermID: %s",R.players.temp[V],R.players.id[V]),true,function(aC,aD,aE)if aE then TriggerServerEvent("CMG:streetRacingRemovePlayerFromRace",R.players.temp[V],Q.gameID)end;if aD then local aN=GetPlayerFromServerId(R.players.temp[V])local aO=GetPlayerPed(aN)local aP=GetEntityCoords(aO)DrawMarker(2,aP.x,aP.y,aP.z+1.8,0.0,0.0,0.0,0.0,180.0,0.0,1.001,1.001,1.001,60,160,227,220,true,true,1,false,false,false,false)end end)end;if#R.players.temp==1 then RageUI.Separator("You are the only player in the race")end;RageUI.ButtonWithStyle("Back","Go Back",{RightLabel="←←←"},true,function(aC,aD,aE)if aE then R.MenuStage=2 end end)end else RageUI.Separator("Error generating game or game in progress, \nleave the circle and come back onto it to try again.")RageUI.Separator("")end end,function()end)end)RageUI.CreateWhile(1,RMenu:Get('street_race','player'),nil,function()RageUI.IsVisible(RMenu:Get('street_race','player'),true,false,true,function()if Q.playerMenuState==1 then if not g then RageUI.Separator(string.format("Wager amount: £%s",tostring(h):reverse():gsub("%d%d%d","%1,"):reverse():gsub("^,","")))RageUI.ButtonWithStyle("Pay wager and join race",string.format("Select to join the race for £%s",tostring(h):reverse():gsub("%d%d%d","%1,"):reverse():gsub("^,","")),{RightLabel="→→→"},true,function(aC,aD,aE)if aE and not p then if GetPedInVehicleSeat(GetVehiclePedIsIn(CMG.getPlayerPed(),false),-1)==CMG.getPlayerPed()then p=true;TriggerServerEvent("CMG:streetRacingTakeMoney",h,b)else tvRP.notify('~r~You are not the driver of the vehicle')end end end,nil)else RageUI.Separator("Waiting for the host to start the race...")local aH=J/1000.0;if aH==0 then RageUI.Separator("~w~Track Record: ~g~--:--.---. By: N/A")else local aI=math.floor(aH/60.0)aH=aH-60.0*aI;RageUI.Separator(string.format("~w~Track Record: ~g~%02d:%05.2f. By %s",aI,aH,K))end;local aJ=H/1000.0;if aJ==0 then RageUI.Separator("~w~Personal Best: ~b~--:--.--")else local aK=math.floor(aJ/60.0)aJ=aJ-60.0*aK;RageUI.Separator(string.format("~w~Personal Best: ~b~%02d:%05.2f",aK,aJ))end;RageUI.ButtonWithStyle("Leave Race","Select to leave the race",{RightLabel="←←←"},true,function(aC,aD,aE)if aE and not p then Q.playerMenuState=2 end end)end else RageUI.Separator("Are you sure you want to leave?")RageUI.Button("No","No",true,function(aC,aD,aE)if aE then Q.playerMenuState=1 end end)RageUI.Button("Yes","Leave the Race",true,function(aC,aD,aE)if aE and not p then p=true;TriggerServerEvent("CMG:streetRacingRemovePlayerFromRace",GetPlayerServerId(PlayerId()),Q.gameID)end end)RageUI.ButtonWithStyle("Back","Go Back",{RightLabel="←←←"},true,function(aC,aD,aE)if aE then Q.playerMenuState=1 end end)end end,function()end)end)RageUI.CreateWhile(1,RMenu:Get('street_race','finish'),nil,function()RageUI.IsVisible(RMenu:Get('street_race','finish'),true,false,true,function()RageUI.Separator("Waiting for other players to finish the race...")if P-GetGameTimer()>0 then local aQ=(P-GetGameTimer())/1000.0;local aR=math.floor(aQ/60.0)if aQ<=0 then aQ=0 end;aQ=aQ-60.0*aR;RageUI.Separator(string.format("~w~Time left: ~r~%02d:%05.2f",aR,aQ))elseif P~=-1 then TriggerServerEvent("CMG:streetRacingRaceComplete",Q.gameID)end;local aQ=(GetGameTimer()-k)/1000.0;if aQ>=870 and P==-1 then TriggerEvent("CMG:streetRacingStartDNFTimer",30000)end end,function()end)end)Citizen.CreateThread(function()while true do local aS=false;while Q.state~=0 do Citizen.Wait(0)local aT=CMG.getPlayerPed()if IsPedInAnyVehicle(aT,false)then local Y=GetEntityCoords(aT)local aU=GetVehiclePedIsIn(aT,false)if Q.state==2 then RageUI.Visible(RMenu:Get('street_race','host'),false)RageUI.Visible(RMenu:Get('street_race','player'),false)DisableControlAction(0,75,true)DisableControlAction(27,75,true)if GetPedInVehicleSeat(aU,-1)~=CMG.getPlayerPed()then SetPedIntoVehicle(CMG.getPlayerPed(),aU,-1)end;DisableControlAction(0,49,true)local aV=a.races[Q.raceID]if Q.checkpoint==0 then Q.checkpoint=1;local ad=j[Q.checkpoint]local aW=Q.checkpoint<#aV.checkpoints and 45 or 9;ad.checkpoint=CreateCheckpoint(aW,ad.vector.x,ad.vector.y,ad.vector.z,0,0,0,10.0,255,255,0,127,0)SetCheckpointCylinderHeight(ad.checkpoint,10.0,10.0,25.0)SetBlipRoute(i[Q.checkpoint],true)SetBlipRouteColour(i[Q.checkpoint],5)else local ad=j[Q.checkpoint]if#(Y-ad.vector)<8.0 then if GetVehiclePedIsIn(CMG.getPlayerPed(),false)==Q.vehicle then RemoveBlip(i[Q.checkpoint])DeleteCheckpoint(ad.checkpoint)if Q.checkpoint==#j then Q.state=3;PlaySoundFrontend(-1,"ScreenFlash","WastedSounds")local aX=GetGameTimer()-k;local aQ=aX/1000.0;local aR=math.floor(aQ/60.0)aQ=aQ-60.0*aR;if GetResourceKvpInt(tostring(Q.raceID))~=nil then I=GetResourceKvpInt(tostring(Q.raceID))if GetResourceKvpInt(tostring(Q.raceID))==0 then SetResourceKvpInt(tostring(Q.raceID),aX)H=GetResourceKvpInt(tostring(Q.raceID))elseif GetResourceKvpInt(tostring(Q.raceID))>aX then SetResourceKvpInt(tostring(Q.raceID),aX)H=GetResourceKvpInt(tostring(Q.raceID))end end;RMenu:Get('street_race','finish'):SetSubtitle(string.format("You Finished!  -  Your time: ~g~%02d:%06.3f",aR,aQ))TriggerServerEvent('CMG:streetRacingFinishedRace',Q.gameID,aX,Q.index)else PlaySoundFrontend(-1,"RACE_PLACED","HUD_AWARDS")Q.checkpoint=Q.checkpoint+1;G=GetEntityHeading(CMG.getPlayerPed())TriggerServerEvent("CMG:streetRacingUpdateCPStatus",Q.gameID,Q.index,Q.checkpoint)local aY=j[Q.checkpoint]local aW=Q.checkpoint<#aV.checkpoints and 45 or 9;aY.checkpoint=CreateCheckpoint(aW,aY.vector.x,aY.vector.y,aY.vector.z-2,0,0,0,10.0,255,255,0,127,0)SetCheckpointCylinderHeight(aY.checkpoint,10.0,10.0,25.0)SetBlipRoute(i[Q.checkpoint],true)SetBlipRouteColour(i[Q.checkpoint],5)if Q.checkpoint==2 then DeleteEntity(E)end end else tvRP.notify("~r~You are not in the correct vehicle")end end end;if#O>0 then for V=1,#O,1 do local aN=GetPlayerFromServerId(O[V])local aZ=GetPlayerPed(aN)local a_=GetVehiclePedIsIn(aZ,false)SetEntityNoCollisionEntity(GetVehiclePedIsIn(CMG.getPlayerPed(),false),a_,true)SetEntityNoCollisionEntity(a_,GetVehiclePedIsIn(CMG.getPlayerPed()),true)end end;if GetEntityRoll(aU)<-130 or GetEntityRoll(aU)>130 then if M==-1 then M=GetGameTimer()elseif GetGameTimer()-M>=3500 then aS=true end elseif M~=-1 then aS=false;M=-1 end;if GetVehicleEngineHealth(aU)<=150 or IsEntityInWater(aU)or aS then aS=false;M=-1;DoScreenFadeOut(2000)NetworkFadeOutEntity(aU,true,false)Wait(2000)if Q.checkpoint-1>0 then SetEntityCoords(aU,j[Q.checkpoint-1].vector.x,j[Q.checkpoint-1].vector.y,j[Q.checkpoint-1].vector.z,0.0,0.0,0.0,false)else SetEntityHeading(CMG.getPlayerPed(),G)SetEntityCoords(aU,a.races[Q.raceID].startPositions[Q.index].x,a.races[Q.raceID].startPositions[Q.index].y,a.races[Q.raceID].startPositions[Q.index].z,false,false,false,true)end;SetVehicleEngineHealth(aU,9999)SetVehiclePetrolTankHealth(aU,9999)SetVehicleFixed(aU)NetworkFadeInEntity(aU,0)DoScreenFadeIn(2000)end;local aQ=(GetGameTimer()-k)/1000.0;if aQ>=870 and P==-1 then TriggerEvent("CMG:streetRacingStartDNFTimer",30000)end;local aR=math.floor(aQ/60.0)aQ=aQ-60.0*aR;DrawGTATimerBar("Time",string.format("~y~%02d:%05.2f",aR,aQ),3)local ad=j[Q.checkpoint]local b0=math.floor(GetDistanceBetweenCoords(Y.x,Y.y,Y.z,ad.vector.x,ad.vector.y,0,false))DrawGTATimerBar("Position",L,4)DrawGTATimerBar("Checkpoint",string.format("%d/%d",Q.checkpoint,#aV.checkpoints),2)DrawGTATimerBar("Distance",string.format("%dm",b0),1)if P-GetGameTimer()>0 then local a2;local aQ=(P-GetGameTimer())/1000.0;if aQ<=0 then aQ=0;v=false;Wait(100)PlaySoundFrontend(-1,"ScreenFlash","WastedSounds")Q.state=4 elseif math.floor(aQ)==5 and not v then v=true;PlaySoundFrontend(-1,"5s","MP_MISSION_COUNTDOWN_SOUNDSET",0)end;local aR=math.floor(aQ/60.0)aQ=aQ-60.0*aR;local b1=string.format("~w~Time left: ~r~%02d:%05.2f",aR,aQ)if not u then a2=Scaleform("MIDSIZED_MESSAGE")end;a2.RunFunction("SHOW_SHARD_MIDSIZED_MESSAGE",{"~y~DNF Timer Started",b1})a2.Render2D()elseif P~=-1 then TriggerServerEvent("CMG:streetRacingRaceComplete",Q.gameID)end elseif Q.state==3 then RageUI.Visible(RMenu:Get('street_race','host'),false)RageUI.Visible(RMenu:Get('street_race','player'),false)RageUI.Visible(RMenu:Get('street_race','finish'),true)DisableControlAction(0,75,true)DisableControlAction(27,75,true)DisableControlAction(0,49)SetEntityHeading(CMG.getPlayerPed(),a.races[Q.raceID].startHeading)SetEntityCoords(aU,a.races[Q.raceID].startPositions[Q.index].x,a.races[Q.raceID].startPositions[Q.index].y,a.races[Q.raceID].startPositions[Q.index].z,false,false,false,true)FreezeEntityPosition(aU,true)elseif Q.state==1 then DisableControlAction(0,75,true)DisableControlAction(27,75,true)DisableControlAction(0,49)local aV=a.races[Q.raceID]local aX=GetGameTimer()y=k-aX;if z==-1 and m then z=k-GetGameTimer()end;if y<=0 and m then Q.state=2;Q.checkpoint=0;FreezeEntityPosition(aU,false)TaskStandStill(E,100000)elseif y<=60000 and m then if math.ceil(y/1000.0)==5 and not q then q=true;SetVehicleEngineHealth(aU,9999)SetVehiclePetrolTankHealth(aU,9999)SetVehicleFixed(aU)elseif math.ceil(y/1000.0)==10 and not F then F=true;RequestAnimDict("random@street_race")while not HasAnimDictLoaded("random@street_race")do Wait(0)end;TaskPlayAnim(E,"random@street_race","grid_girl_race_start",8.0,8.0,-1,48,0,false,false,false)RemoveAnimDict("random@street_race")elseif math.ceil(y/1000.0)==20 and not D then D=true;local b2=CMG.loadModel(`csb_stripper_01`)E=CreatePed(3,b2,a.races[Q.raceID].ped.start.x,a.races[Q.raceID].ped.start.y,a.races[Q.raceID].ped.start.z,a.races[Q.raceID].ped.startHeading,false,true)SetEntityNoCollisionEntity(E,GetVehiclePedIsIn(CMG.getPlayerPed()),false)TaskGoStraightToCoord(E,a.races[Q.raceID].ped.finish.x,a.races[Q.raceID].ped.finish.y,a.races[Q.raceID].ped.finish.z,1.49,-1,a.races[Q.raceID].ped.finalHeading,0)SetModelAsNoLongerNeeded(b2)end;if not x then x=true;TriggerEvent("CMG:streetRacingShowCountdownTimer",math.ceil(y/1000.0))end;FreezeEntityPosition(aU,true)end;SetEntityHeading(CMG.getPlayerPed(),a.races[Q.raceID].startHeading)SetEntityCoords(aU,a.races[Q.raceID].startPositions[Q.index].x,a.races[Q.raceID].startPositions[Q.index].y,a.races[Q.raceID].startPositions[Q.index].z,false,false,false,true)end end end;Citizen.Wait(400)end end)Citizen.CreateThread(function()if not HasStreamedTextureDictLoaded('timerbars')then RequestStreamedTextureDict('timerbars')while not HasStreamedTextureDictLoaded('timerbars')do Wait(0)end end end)Citizen.CreateThread(function()for V=1,#a.races,1 do tvRP.addBlip(a.races[V].start.x,a.races[V].start.y,a.races[V].start.z,315,0,"Street Race")end end)
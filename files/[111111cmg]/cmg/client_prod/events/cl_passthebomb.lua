local a=module("cfg/events/cfg_passthebomb")local b={}local c=CMG.createTimerBars()local function d()DisableControlAction(0,23,true)DisableControlAction(0,75,true)DisableControlAction(0,24,true)DisableControlAction(0,25,true)DisableControlAction(0,37,true)DisableControlAction(0,12,true)DisableControlAction(0,13,true)DisableControlAction(0,14,true)DisableControlAction(0,15,true)DisableControlAction(0,16,true)DisableControlAction(0,17,true)DisableControlAction(0,53,true)DisableControlAction(0,54,true)DisableControlAction(0,99,true)DisableControlAction(0,100,true)DisableControlAction(0,261,true)DisableControlAction(0,262,true)end;local function e(f,g)if g-f.updated>5000 then f.updated=g;UseParticleFxAsset(f.asset)StartParticleFxNonLoopedAtCoord(f.name,f.pos.x,f.pos.y,f.pos.z,0.0,0.0,0.0,1.0,false,false,false)end end;local function h(i,g)if g-i.updated>5000 then i.updated=g;Citizen.CreateThread(function()local j=GetSoundId()PlaySoundFromCoord(j,i.name,i.pos.x,i.pos.y,i.pos.z,i.soundset,false,0,false)Citizen.Wait(5000)StopSound(j)ReleaseSoundId(j)end)end end;local function k(l)local g=GetGameTimer()local m=GetEntityCoords(l,true)if b.particles then for n,f in ipairs(b.particles)do if#(f.pos-m)<f.range then e(f,g)end end end;if b.sounds then for n,i in ipairs(b.sounds)do if#(i.pos-m)<i.range then h(i,g)end end end end;local function o(p,l)if p then if not Entity(l).state.particle then UseParticleFxAsset("scr_ar_planes")local q=StartParticleFxLoopedOnEntity("scr_ar_trail_smoke",l,0.0,-1.0,0.0,0.0,0.0,0.0,1.0,false,false,false)SetParticleFxLoopedScale(q,0.5)SetParticleFxLoopedFarClipDist(q,1000.0)SetParticleFxLoopedColour(q,1.0,0.0,0.0)Entity(l).state.particle=q end else local q=Entity(l).state.particle;if q then StopParticleFxLooped(q,false)Entity(l).state.particle=nil end end end;local function r(s)if not b.boxes then return end;for n,t in ipairs(b.boxes)do if t.visible then DrawMarker(32,t.pos.x,t.pos.y,t.pos.z+2.0,0.0,0.0,0.0,0.0,0.0,0.0,5.0,5.0,5.0,0,255,0,255,true,true,2,false,nil,nil,false)if#(t.pos-s)<5.0 and not b.hasBoost then TriggerServerEvent("CMG:ptbEnteredBox",n)end end end end;local function u(v)local w=a.locations[v]b.colour=1;b.vehicles=w.vehicles;b.bounds=w.bounds;b.confirmedCharacter=false;if w.particles then b.particles=json.decode(json.encode(w.particles))for n,f in ipairs(b.particles)do f.pos=vector3(f.pos.x,f.pos.y,f.pos.z)f.updated=0 end end;if w.sounds then b.sounds=json.decode(json.encode(w.sounds))for n,i in ipairs(b.sounds)do i.pos=vector3(i.pos.x,i.pos.y,i.pos.z)i.updated=0 end end;if w.boxes then b.boxes=json.decode(json.encode(w.boxes))for n,t in ipairs(b.boxes)do t.pos=vector3(t.pos.x,t.pos.y,t.pos.z)t.visible=true end end end;local function x()SetPedIntoVehicle(PlayerPedId(),b.vehicle,-1)local y=GetGameTimer()local z=b;while not NetworkHasControlOfEntity(b.vehicle)and GetGameTimer()-y<2000 do Citizen.Wait(0)if z~=b then return end end;if b.position==nil then print("[Pass The Bomb] Deleting vehicle on spawn, no position was set.")DeleteEntity(b.vehicle)return end;SetEntityCoordsNoOffset(b.vehicle,b.position.x,b.position.y,b.position.z,true,false,false)SetVehicleOnGroundProperly(b.vehicle)FreezeEntityPosition(b.vehicle,true)SetVehRadioStation(b.vehicle,"OFF")SetVehicleRadioEnabled(b.vehicle,false)SetEntityProofs(b.vehicle,false,false,false,false,false,false,false,false)Citizen.CreateThreadNow(function()local A=-1;local B=-1;while A~=b.colour or B~=b.colour do SetVehicleColours(b.vehicle,b.colour,b.colour)A,B=GetVehicleColours(b.vehicle)Citizen.Wait(0)end end)end;RegisterNetEvent("CMG:ptbVehicleSpawned",function(C)if DoesEntityExist(b.vehicle)then DeleteEntity(b.vehicle)end;local z=b;while not DoesEntityExist(b.vehicle)do if NetworkDoesEntityExistWithNetworkId(C)then b.vehicle=NetworkGetEntityFromNetworkId(C)end;Citizen.Wait(0)if z~=b then return end end;while not NetworkHasControlOfEntity(b.vehicle)or GetPedInVehicleSeat(b.vehicle,-1)~=PlayerPedId()do Citizen.Wait(0)if z~=b then return end end;x()end)local function D()local E={}for F,G in ipairs(CMG.getActiveEventPlayers())do if G.hasBomb then local H=GetPlayerFromServerId(G.source)if H~=-1 then table.insert(E,CMG.getPlayerName(H))end end end;if#E==2 then return string.format("~y~Escape~w~ the ~r~bombers~w~ %s and %s",E[1],E[2])elseif#E==1 then return string.format("~y~Escape~w~ %s the ~r~bomber~w~",E[1])end;return"~y~Escape~w~ the ~r~bomber~w~"end;local function I()if not DoesEntityExist(b.vehicle)then return end;b.boostHandling={downforce=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fDownforceModifier"),driveInertia=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fDriveInertia"),curveMin=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fTractionCurveMin"),curveMax=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fTractionCurveMax"),antiRollBarForce=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fAntiRollBarForce"),antiRollBarBiasFront=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fAntiRollBarBiasFront"),rollCentreHeightFront=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fRollCentreHeightFront"),rollCentreHeightRear=GetVehicleHandlingFloat(b.vehicle,"CHandlingData","fRollCentreHeightRear")}local J=GetEntityModel(b.vehicle)local K=a.handlings[J]assert(K,string.format("Handling does not exist for model %d",J))SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fDownforceModifier",K.fDownforceModifier)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fDriveInertia",b.boostHandling.driveInertia*1.5)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fTractionCurveMin",K.fTractionCurveMin)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fTractionCurveMax",K.fTractionCurveMax)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fAntiRollBarForce",K.fAntiRollBarForce)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fAntiRollBarBiasFront",K.fAntiRollBarBiasFront)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fRollCentreHeightFront",K.fRollCentreHeightFront)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fRollCentreHeightRear",K.fRollCentreHeightRear)end;local function L()SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fDownforceModifier",b.boostHandling.downforce)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fDriveInertia",b.boostHandling.driveInertia)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fTractionCurveMin",b.boostHandling.curveMin)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fTractionCurveMax",b.boostHandling.curveMax)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fAntiRollBarForce",b.boostHandling.antiRollBarForce)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fAntiRollBarBiasFront",b.boostHandling.antiRollBarBiasFront)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fRollCentreHeightFront",b.boostHandling.rollCentreHeightFront)SetVehicleHandlingFloat(b.vehicle,"CHandlingData","fRollCentreHeightRear",b.boostHandling.rollCentreHeightRear)b.boostHandling=nil end;local function M(N,O)return HasEntityBeenDamagedByEntity(N,O,true)or HasEntityBeenDamagedByEntity(O,N,true)or IsEntityTouchingEntity(N,O)or IsEntityTouchingEntity(O,N)end;local function P(Q,R,G)local j=GetPlayerFromServerId(G.source)if j==-1 then return end;local S=GetPlayerPed(j)local T=HasEntityClearLosToEntity(Q,S,17)SetMpGamerTagVisibility(G.tag,0,T)SetMpGamerTagVisibility(G.tag,29,G.hasBomb and T)if G.blip and G.active then local U=GetBlipColour(G.blip)SetBlipSprite(G.blip,G.hasBomb and 486 or 1)SetBlipScale(G.blip,G.hasBomb and 1.5 or 1.0)BeginTextCommandSetBlipName("STRING")AddTextComponentSubstringPlayerName(CMG.getPlayerName(j))EndTextCommandSetBlipName(G.blip)SetBlipColour(G.blip,U)end;local V=GetVehiclePedIsUsing(S)if V==0 then return end;o(G.hasBomb,V)k(V)local W=CMG.getEventLocalPlayer()if W and W.hasBomb then if not G.hasBomb and M(V,R)then TriggerServerEvent("CMG:ptbPassBombToPlayer",G.source)ClearEntityLastDamageEntity(V)ClearEntityLastDamageEntity(R)end end end;local function X()local Y=#CMG.getActiveEventPlayers()local Z=#currentEvent.players-Y;c.push("~y~ELIMINATED~w~",tostring(Z))c.push("~y~REMAINING~w~",tostring(Y))end;local function _()d()c.reset()X()local W=CMG.getEventLocalPlayer()local Q=PlayerPedId()local R=GetVehiclePedIsUsing(Q)if R==0 then if W and W.active then SetPedIntoVehicle(Q,b.vehicle,-1)end elseif R~=b.vehicle then b.vehicle=R end;for n=0,5 do SetTyreTractionLossMultiplier(b.vehicle,n,0.0)end;FreezeEntityPosition(b.vehicle,false)SetVehicleEngineOn(b.vehicle,true,true,false)SetVehicleColours(b.vehicle,b.colour,b.colour)for F,G in ipairs(currentEvent.players)do P(Q,R,G)end;if W and W.active then if not DoesEntityExist(b.vehicle)or GetEntityHealth(Q)<=10 or IsPedDeadOrDying(Q)or GetEntityHealth(b.vehicle)<=50 then TriggerServerEvent("CMG:ptbClientFailed")W.active=false end;local s=GetEntityCoords(Q,true)r(s)SetPlayerControl(PlayerId(),true,0)if W.hasBomb or b.hasBoost then if not b.boostHandling then I()end else if b.boostHandling then L()end end;if W.hasBomb then drawNativeText("You have the ~r~bomb~w~. Hit another ~y~vehicle~w~ to pass it on")else drawNativeText(D())end else if b.boostCounter then b.boostCounter=0 end;drawNativeText(D())end;if b.boostCounter and b.boostCounter>0 then c.push("~b~BOOST TIME~w~",tostring(b.boostCounter))end;if b.explosionCounter and b.explosionCounter>0 then c.push("~r~EXPLOSION IN~w~",tostring(b.explosionCounter))end;c.draw()end;RegisterNetEvent("CMG:ptbLoad",function(v,a0,a1)currentEvent.drawPlayersTimeBar=false;SetPlayerControl(PlayerId(),false,0)u(v)loadMap(a0,false,true)local a2=PlayerPedId()SetEntityCoordsNoOffset(a2,a1.x,a1.y,a1.z,true,false,false)SetEntityHeading(a2,a1.w)RequestScriptAudioBank("DLC_STUNT/STUNT_RACE_01",false)RequestScriptAudioBank("DLC_STUNT/STUNT_RACE_02",false)RequestScriptAudioBank("DLC_STUNT/STUNT_RACE_03",false)CMG.setEventMusic("AW_LOBBY_MUSIC_START")if b.particles then for n,f in ipairs(b.particles)do CMG.loadPtfx(f.asset)end end;CMG.loadPtfx("scr_ar_planes")end)RegisterNetEvent("CMG:ptbSelect",function(a3)CMG.stopEventSequence()BusyspinnerOff()SetPlayerControl(PlayerId(),true,0)SetEntityVisible(PlayerPedId(),true,0)CMG.startVehicleSelection(a3.xyz,a3.w,b.vehicles,20,function(a4)TriggerServerEvent("CMG:ptbSetVehicle",a4)end,function(a5)b.colour=a5 end)b.state="SELECT"b.position=a3;while b.state=="SELECT"do local l=GetVehiclePedIsUsing(PlayerPedId())if l~=0 then FreezeEntityPosition(l,true)end;Citizen.Wait(0)end end)RegisterNetEvent("CMG:ptbStart",function()b.state="BEFORE_START"if DoesEntityExist(b.vehicle)then DeleteEntity(b.vehicle)end;for F,G in pairs(GetActivePlayers())do SetEntityVisible(GetPlayerPed(G),true,0)end;Citizen.CreateThreadNow(function()while b.state=="SELECT"or b.state=="BEFORE_START"do d()local R=GetVehiclePedIsUsing(PlayerPedId())if R~=0 then FreezeEntityPosition(R,true)end;Citizen.Wait(0)end end)CMG.endVehicleSelection()SetFollowPedCamViewMode(2)CMG.showUI()SetGameplayCamRelativeHeading(GetEntityHeading(b.vehicle))CMG.enableEventPlayerBlips(true)CMG.enableEventPlayerTags(true,false)CMG.setEventBounds(b.bounds)CMG.showCountdownTimer(3)if b.state~="BEFORE_START"then return end;CMG.setPlayerCanOpenLeaderboard(true)b.state="START"while b.state=="START"do _()Citizen.Wait(0)end end)RegisterNetEvent("CMG:ptbExplodeCountdown",function()local a6=0;b.explosionCounter=5;while b.explosionCounter do if GetGameTimer()-a6>1000 then b.explosionCounter=b.explosionCounter-1;a6=GetGameTimer()if b.explosionCounter==0 then b.explosionCounter=nil;return else PlaySoundFrontend(-1,"Checkpoint_Buzz","DLC_AW_Frontend_Sounds",false)end end;Citizen.Wait(0)end end)RegisterNetEvent("CMG:ptbExplodePlayer",function(a7)local G=GetPlayerFromServerId(a7)if G==-1 then return end;local a5=CMG.getPlayerColour(a7)notify(a5 ..CMG.getPlayerName(G).." ~w~has been eliminated!")ShakeGameplayCam("MEDIUM_EXPLOSION_SHAKE",1.0)local a2=GetPlayerPed(G)SetEntityHealth(a2,0)local a8=GetVehiclePedIsUsing(a2)if a8~=0 then ExplodeVehicle(a8,true,false)end;local m=GetEntityCoords(a2,true)for n=1,15 do local a9=m.x+(math.random()-0.5)*8.0;local aa=m.y+(math.random()-0.5)*8.0;local ab=m.z+(math.random()-0.5)*4.0;AddExplosion(a9,aa,ab,0,1.0,true,false,5.0)end end)RegisterNetEvent("CMG:ptbEnteredBox",function(ac,a7)local t=b.boxes[ac]t.visible=false;local G=GetPlayerFromServerId(a7)if G==-1 then return end;local a2=GetPlayerPed(G)if a2==0 then return end;local a8=GetVehiclePedIsUsing(a2)if a8==0 then return end;if a2==PlayerPedId()then AnimpostfxPlay("MinigameEndNeutral",0,false)PlaySoundFrontend(-1,"Hit_1","LONG_PLAYER_SWITCH_SOUNDS",true)local a6=GetGameTimer()local ad=a6;b.hasBoost=true;b.boostCounter=20;while GetGameTimer()-a6<20000 and b.state=="START"do if GetGameTimer()-ad>=1000 then ad=GetGameTimer()b.boostCounter=b.boostCounter-1 end;Citizen.Wait(0)end;b.hasBoost=false;b.boostCounter=nil;SetVehicleCheatPowerIncrease(a8,1.0)end end)RegisterNetEvent("CMG:ptbBoxNowAvaliable",function(ac)local t=b.boxes[ac]t.visible=true end)RegisterNetEvent("CMG:ptbSetBombers",function(ae)for F,G in ipairs(currentEvent.players)do G.hasBomb=false;for F,af in ipairs(ae)do if G.source==af then G.hasBomb=true end end end end)RegisterNetEvent("CMG:ptbEliminatedNotify",function(a5,v)notify(a5 ..v.." ~w~has been eliminated")end)Citizen.CreateThread(function()for ag,ah in pairs(a.locations)do local ai=nil;CMG.registerEventMenuItem("Pass The Bomb",ag,function()if not currentEvent.isActive then RageUI.Separator("Minimum Players: "..tostring(a.minPlayers))RageUI.Separator("Maximum Players: "..tostring(#ah.spawnpoints))local aj={RightLabel=not ai and"~y~DEFAULT"or ai}RageUI.ButtonWithStyle("Vehicle Selection","Enter a specific vehicle to use or leave empty to use default.",aj,true,function(ak,al,am)if am then CMG.clientPrompt("Enter Spawncode","",function(an)ai=#an>=3 and string.upper(an)or nil end)end end)RageUI.ButtonWithStyle("Start Event",nil,{RightLabel="→→→"},true,function(ak,al,am)if am then TriggerServerEvent("CMG:startEvent","Pass The Bomb",ag,a.minPlayers,#ah.spawnpoints,{customSpawncode=ai})end end)end end)CMG.registerEventCleanupHandler(ag,function()CMG.enableEventPlayerBlips(false)CMG.enableEventPlayerTags(false,false)if b.boostHandling then L()end;DeleteEntity(b.vehicle)ReleaseNamedScriptAudioBank("DLC_STUNT/STUNT_RACE_01")ReleaseNamedScriptAudioBank("DLC_STUNT/STUNT_RACE_02")ReleaseNamedScriptAudioBank("DLC_STUNT/STUNT_RACE_03")CMG.setPlayerCanOpenLeaderboard(false)if b.particles then for n,f in ipairs(b.particles)do RemoveNamedPtfxAsset(f.asset)end end;RemoveNamedPtfxAsset("scr_ar_planes")CMG.cleanupRockstarMaps()if not CMG.isPodiumDrawing()then CMG.showUI()end;TriggerMusicEvent("BST_STOP")BusyspinnerOff()SetPlayerControl(PlayerId(),true,0)b={}end)end end)
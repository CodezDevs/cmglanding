local a=false;local b=nil;local c=0;local d=90;local e=-3.5;local f=nil;local g=vector3(5218.9399414062,-5393.2563476562,67.318588256836)local function h(i,e,c,d)local j=math.rad(c)local k=math.rad(d)return vector3(i.x+e*math.sin(k)*math.cos(j),i.y-e*math.sin(k)*math.sin(j),i.z-e*math.cos(k))end;RegisterNetEvent("CMG:spectatePlayer",function(l,m)local n=PlayerPedId()FreezeEntityPosition(n,true)SetEntityCollision(n,false,false)SetEntityVisible(n,false,0)SetEntityInvincible(n,true)local o=math.random(7500,8900)local p=math.random(7500,8900)local q=math.random(1,2)==2;if q then o=-o;p=-p end;SetEntityCoordsNoOffset(n,o+0.0,p+0.0,1000.0,false,false,false)f=CreateCamWithParams("DEFAULT_SCRIPTED_CAMERA",m.x,m.y,m.z,0.0,0.0,0.0,GetGameplayCamFov(),false,2)SetCamActive(f,true)RenderScriptCams(true,false,0,true,true)b=l;while true do if not b then return end;SetFocusPosAndVel(m.x,m.y,m.z,0.0,0.0,0.0)LockMinimapPosition(m.x,m.y)SetPlayerBlipPositionThisFrame(m.x,m.y)if GetPlayerFromServerId(l)~=-1 then break end;Citizen.Wait(0)end;a=true end)RegisterNetEvent("CMG:stopSpectatePlayer",function()a=false;ClearFocus()b=nil;UnlockMinimapPosition()SetCamActive(f,false)RenderScriptCams(false,false,0,false,false)DestroyCam(f,false)local n=PlayerPedId()SetEntityInvincible(n,false)SetEntityVisible(n,true,0)SetEntityCollision(n,true,true)FreezeEntityPosition(n,false)if#(CMG.getPlayerCoords()-g)>2142.0 then if CMG.isInCayoPerico()then DisableCayoPerico(true)end end end)local function r(s,t,u,v,w,x,y,z,A,B)CMG.DrawText(s-u/2,t-v/2+0.005,x,w,0,1,{y,z,A,B})end;Citizen.CreateThread(function()while true do Wait(0)if a then local C=GetPlayerFromServerId(b)if C~=-1 then local n=CMG.getPlayerPed()local D=GetPlayerPed(C)if D~=0 then local E=GetEntityCoords(D)local F=GetEntityHealth(D)local G=GetEntityMaxHealth(D)local H=GetSelectedPedWeapon(D)local I=GetPedArmour(D)local J=GetAmmoInPedWeapon(D,H)r(0.76,1.44,1.0,1.0,0.4,"Health: "..F.."/"..G,51,153,255,200)r(0.76,1.415,1.0,1.0,0.4,"Armor: "..I,51,153,255,200)r(0.76,1.39,1.0,1.0,0.4,"Vehicle Health: "..GetEntityHealth(GetVehiclePedIsIn(D,false)),51,153,255,200)local K=tostring(WeaponNames[H])r(0.76,1.365,1.0,1.0,0.4,"Weapon: "..(K or"N/A"),51,153,255,200)r(0.76,1.340,1.0,1.0,0.4,"Ammo: "..(J or"N/A"),51,153,255,200)local L=GetActivePlayers()for M,N in pairs(L)do local O=GetPlayerPed(N)SetEntityNoCollisionEntity(n,O,true)end;DisableControlAction(2,15,true)DisableControlAction(2,17,true)if IsControlPressed(2,241)then e=e+0.5 end;DisableControlAction(2,14,true)DisableControlAction(2,16,true)if IsControlPressed(2,242)then e=e-0.5 end;if e>-1 then e=-1 end;local P=GetDisabledControlNormal(0,1)local Q=GetDisabledControlNormal(0,2)c=c+P*10;if c>=360 then c=0 end;d=d+Q*10;if d>=360 then d=0 end;local R=h(E,e,c,d)SetCamCoord(f,R.x,R.y,R.z)PointCamAtEntity(f,D,0.0,0.0,0.0,false)SetFocusPosAndVel(E.x,E.y,E.z,0.0,0.0,0.0)LockMinimapPosition(E.x,E.y)SetPlayerBlipPositionThisFrame(E.x,E.y)if#(GetFinalRenderedCamCoord()-g)<2142.0 then if not CMG.isInCayoPerico()then EnableCayoPerico(true)end else if CMG.isInCayoPerico()then DisableCayoPerico(true)end end end else tvRP.notify("~r~Couldn't spectate, person not in your zone")end end end end)local S={}AddStateBagChangeHandler("conceal",nil,function(T,U,V)local W=tonumber(stringsplit(T,":")[2])if V then S[W]=true else local X=GetPlayerFromServerId(W)if X~=-1 and X~=PlayerId()then NetworkConcealPlayer(X,false,false)end;S[W]=nil end end)RegisterNetEvent("onPlayerDropped",function(W)S[W]=nil end)local function Y()for W in pairs(S)do local X=GetPlayerFromServerId(W)if X~=-1 and X~=PlayerId()then NetworkConcealPlayer(X,true,true)end end end;CMG.createThreadOnTick(Y)function CMG.isInSpectate()return a end
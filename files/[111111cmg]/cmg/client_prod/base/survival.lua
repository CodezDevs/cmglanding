local a={}local b=false;local c=0;local d=300;local e=false;local f=100;local g=false;local h;local i=GetGameTimer()local j=0;local k=102;local l=0;local m=false;local n=nil;WeaponNames={}local o=module("cfg/weapons")local p=module("cfg/cfg_spawn")local q={}local r={}Citizen.CreateThread(function()r=o.nativeWeaponModelsToNames;for s,t in pairs(o.weapons)do r[s]=t.name end;for s,u in pairs(r)do WeaponNames[GetHashKey(s)]=u;q[GetHashKey(s)]=s end;local v=module("cfg/homes")for w,x in pairs(v.homes)do p.spawnLocations[w]={name=w,coords=vector3(x.entry_point[1],x.entry_point[2],x.entry_point[3]),permission={},image=x.image or"https://cdn.cmg.city/content/fivem/houses/citysmallhome.png",price=5000}end end)local y=-1;RegisterNetEvent("CMG:setNHSCallerId",function(z)y=z end)AddEventHandler("CMG:countdownEnded",function()e=true end)Citizen.CreateThread(function()while true do if IsDisabledControlJustPressed(0,38)then if b and not g then local A=GetEntityCoords(GetPlayerPed(-1))if not CMG.isInPaintball()and not globalInBoxingZone and not CMG.isPlayerInRedZone()and not CMG.isPlayerInTurf()then PlaySoundFrontend(-1,"SELECT","HUD_FRONTEND_DEFAULT_SOUNDSET",false)tvRP.notify("~g~NHS have been notified.")vRPserver.callNHS({A.x,A.y,A.z})TriggerEvent("CMG:DEATH_SCREEN_NHS_CALLED")end;g=true elseif e and b then PlaySoundFrontend(-1,"SELECT","HUD_FRONTEND_DEFAULT_SOUNDSET",false)TriggerEvent("CMG:CLOSE_DEATH_SCREEN")tvRP.respawnPlayer()g=false;if y~=-1 then TriggerServerEvent("CMG:endNHSCall",y)end end;Wait(1000)end;Wait(0)end end)local function B(s)if not s then return false end;local t=o.weapons[s]if not t then return false end;if GetGameTimer()<i+j then return false end;if CMG.isKnockedOut()or l>=3 then return false end;return t.class=="Melee"and not t.isLethalMelee end;local function C()local D=CMG.getPlayerCoords()for E,F in pairs(GetGamePool("CPed"))do if IsEntityDead(F)and not IsPedAPlayer(F)and#(GetEntityCoords(F,true)-D)<25.0 then local G=GetEntityModel(F)if G==`mp_m_freemode_01`or G==`mp_f_freemode_01`then DeleteEntity(F)end end end end;Citizen.CreateThread(function()Wait(500)while true do Wait(0)local F=GetPlayerPed(-1)local H=GetEntityHealth(F)if IsEntityDead(GetPlayerPed(-1))and not b and not B(q[GetPedCauseOfDeath(F)])and not CMG.inEvent()then pbCounter=100;local I=GetEntityCoords(GetPlayerPed(-1),true)if currentBackpack then TriggerServerEvent("CMG:storeBackpack",currentBackpack,false,true)end;if not CMG.isPurge()then TriggerServerEvent("CMG:forceStoreWeapons",false,true,true)end;tvRP.ejectVehicle()b=true;h=I;TriggerServerEvent("CMG:getNumOfNHSOnline",h)CMG.updateHealth(true)Wait(250)end;if f<=0 then f=100;local J=GetEntityHealth(GetPlayerPed(-1))while J<=100 do Wait(0)local K=CMG.getPosition()local L=PlayerPedId()NetworkResurrectLocalPlayer(K.x,K.y,K.z,GetEntityHeading(GetPlayerPed(-1)),true,true)DeleteEntity(L)J=GetEntityHealth(GetPlayerPed(-1))end;SetEntityHealth(GetPlayerPed(-1),102)SetEntityInvincible(GetPlayerPed(-1),true)a=getRandomComaAnimation()CMG.loadAnimDict(a.dict)TaskPlayAnim(GetPlayerPed(-1),a.dict,a.anim,3.0,1.0,-1,1,0,0,0,0)RemoveAnimDict(a.dict)C()end;if H>k and b then if IsEntityDead(GetPlayerPed(-1))then local K=CMG.getPosition()local L=PlayerPedId()NetworkResurrectLocalPlayer(K.x,K.y,K.z,GetEntityHeading(GetPlayerPed(-1)),true,true)DeleteEntity(L)Wait(0)end;TriggerEvent("CMG:CLOSE_DEATH_SCREEN")c=0;pbCounter=100;e=false;tvRP.disableComa()f=100;SetEntityInvincible(GetPlayerPed(-1),false)ClearPedSecondaryTask(GetPlayerPed(-1))Citizen.CreateThread(function()Wait(500)ClearPedSecondaryTask(GetPlayerPed(-1))ClearPedTasks(GetPlayerPed(-1))end)end;local H=GetEntityHealth(GetPlayerPed(-1))if H<=k and not b then SetEntityHealth(GetPlayerPed(-1),0)end end end)Citizen.CreateThread(function()while true do if b then local L=PlayerPedId()if not IsEntityDead(L)then if a.dict==nil then a=getRandomComaAnimation()end;if not IsEntityPlayingAnim(L,a.dict,a.anim,3)and not CMG.isUsingStretcher()then if a.dict~=nil then CMG.loadAnimDict(a.dict)TaskPlayAnim(L,a.dict,a.anim,3.0,1.0,-1,1,0,0,0,0)RemoveAnimDict(a.dict)end end end;if GetEntityHealth(L)>k then tvRP.disableComa()if IsEntityDead(L)then local K=CMG.getPosition()local M=PlayerPedId()NetworkResurrectLocalPlayer(K.x,K.y,K.z,GetEntityHeading(GetPlayerPed(-1)),true,true)DeleteEntity(M)Wait(0)end;c=0;pbCounter=100;tvRP.disableComa()f=100;SetEntityInvincible(L,false)ClearPedSecondaryTask(L)end end;Wait(0)end end)RegisterNetEvent("CMG:Revive",function()local F=GetPlayerPed(-1)if IsEntityDead(F)then local K=CMG.getPosition()local L=PlayerPedId()NetworkResurrectLocalPlayer(K.x,K.y,K.z,GetEntityHeading(GetPlayerPed(-1)),true,true)DeleteEntity(L)Citizen.Wait(0)end;local N=PlayerId()SetPlayerControl(N,true,false)if not IsEntityVisible(F)then SetEntityVisible(F,true)end;if not IsPedInAnyVehicle(F)then SetEntityCollision(F,true)end;FreezeEntityPosition(F,false)SetPlayerInvincible(N,false)SetEntityHealth(F,200)tvRP.disableComa()f=100;local F=GetPlayerPed(-1)SetEntityInvincible(F,false)ClearPedSecondaryTask(GetPlayerPed(-1))Citizen.CreateThread(function()Wait(500)ClearPedSecondaryTask(GetPlayerPed(-1))ClearPedTasks(GetPlayerPed(-1))end)TriggerEvent("CMG:CLOSE_DEATH_SCREEN")TriggerServerEvent("CMG:playerRevived")if y~=-1 then TriggerServerEvent("CMG:endNHSCall",y)end end)RegisterNetEvent("CMG:getNumberOfDocsOnline",function(O)if not CMG.isPurge()then if CMG.isPlayerInRedZone()or CMG.isPlayerInTurf()then bleedoutDuration=50000 elseif O>=1 and O<=3 and not globalNHSOnDuty then bleedoutDuration=170000 elseif O>=1 and not globalNHSOnDuty then bleedoutDuration=290000 else bleedoutDuration=50000 end;c=bleedoutDuration+10000 else c=3000 end;d=c/1000;f=10;i=GetGameTimer()j=c;local P=false;if not CMG.isPurge()then if GetVehiclePedIsIn(PlayerPedId(),false)~=0 then P=true else TriggerServerEvent("CMG:createLootbag",h)end end;CreateThread(function()local Q=GetGameTimer()while CMG.getKillerInfo().ready==nil do Wait(0)end;local R=CMG.getKillerInfo()local S=false;if R.name==nil then S=true end;e=false;TriggerEvent("CMG:SHOW_DEATH_SCREEN",d,R.name or"N/A",R.user_id or"N/A",R.weapon or"N/A",S)end)if not CMG.isPurge()then while f<=10 and f>=0 do Wait(1000)f=f-1 end;if P then TriggerServerEvent("CMG:createLootbag",h)end end end)local T=0;RegisterNetEvent("CMG:openSpawnMenu",function(U)DoScreenFadeIn(1000)TriggerScreenblurFadeIn(100.0)CMG.hideUI()SetPlayerControl(PlayerId(),false,0)local L=PlayerPedId()local V=CMG.getPlayerCoords()FreezeEntityPosition(L,true)SetEntityCoordsNoOffset(L,V.x,V.y,-100.0,false,false,false)SetEntityVisible(L,false,0)TriggerEvent("CMG:removeBackpack2")T=CreateCameraWithParams("DEFAULT_SCRIPTED_CAMERA",675.57568359375,1107.1724853516,375.29666137695,0.0,0.0,0.0,65.0,0,2)SetCamActive(T,true)RenderScriptCams(true,true,0,true,false)SetCamParams(T,-1024.6506347656,-2712.0234375,79.889106750488,0.0,0.0,0.0,65.0,250000,0,0,2)local W={}for E,w in pairs(U)do if p.spawnLocations[w]then table.insert(W,p.spawnLocations[w])end end;TriggerEvent("CMGUI:openSpawnMenu",W)end)AddEventHandler("CMG:respawnButtonClicked",function(X,Y)if Y and Y>0 then TriggerServerEvent('CMG:takeAmount',Y)end;local Z=p.spawnLocations[X].coords;TriggerEvent("CMG:playGTAIntro")if tvRP.isHandcuffed()then TriggerEvent("CMG:toggleHandcuffs",false)end;SetEntityCoords(PlayerPedId(),Z)SetEntityVisible(PlayerPedId(),true,0)SetPlayerControl(PlayerId(),true,0)SetFocusPosAndVel(Z.x,Z.y,Z.z+1000)DestroyCam(T)local _=CreateCameraWithParams("DEFAULT_SCRIPTED_CAMERA",Z.x,Z.y,Z.z+1000.0,0.0,0.0,0.0,65.0,0,2)SetCamActive(_,true)RenderScriptCams(true,true,0,true,false)SetCamParams(_,Z.x,Z.y,Z.z,0.0,0.0,0.0,65.0,5000,0,0,2)Wait(2500)ClearFocus()Wait(2000)FreezeEntityPosition(PlayerPedId(),false)DestroyCam(_)RenderScriptCams(false,true,2000,false,false)TriggerScreenblurFadeOut(2000.0)CMG.showUI()ClearFocus()CMG.leaveActiveHouse()end)function tvRP.respawnPlayer()if CMG.inEvent()then if not m then DoScreenFadeOut(1000)Wait(1000)SetEntityVisible(PlayerPedId(),false,false)FreezeEntityPosition(PlayerPedId(),false)end;SetEntityInvincible(PlayerPedId(),false)ResurrectPed(PlayerPedId())if not m then ClearPedTasksImmediately(PlayerPedId())end;RemoveAllPedWeapons(PlayerPedId(),true)TriggerEvent("CMG:eventPlayerSpawned")if not m then Wait(2000)DoScreenFadeIn(2000)end;SetEntityVisible(PlayerPedId(),true,true)if not m and n then SetEntityCoordsNoOffset(PlayerPedId(),n.x,n.y,n.z,false,false,false)if type(n)=="vector4"then SetEntityHeading(PlayerPedId(),n.w)end end else DoScreenFadeOut(1000)c=0;pbCounter=100;e=false;SetEntityInvincible(PlayerPedId(),false)Wait(1000)local L=PlayerPedId()local A=GetEntityCoords(L)SetEntityCoordsNoOffset(L,A.x,A.y,A.z,false,false,false)NetworkResurrectLocalPlayer(A.x,A.y,A.z,0.0,true,true)DeleteEntity(L)ClearPedTasksImmediately(L)RemoveAllPedWeapons(L)TriggerServerEvent("vRPcli:playerSpawned")end end;function tvRP.disableComa()b=false;g=false end;function tvRP.isInComa()return b end;local a0=false;function tvRP.isTazed(a1)return a0 or IsPedBeingStunned(PlayerPedId(),0)or CMG.isPedBeingTackled()or isInGreenzone and not globalOnPoliceDuty and not a1 end;function CMG.isTazedByRevive()return a0 end;RegisterNetEvent("TriggerTazer",function()a0=true;tvRP.setCanAnim(false)local L=PlayerPedId()CMG.loadClipSet("move_m@drunk@verydrunk")SetPedMinGroundTimeForStungun(L,15000)SetPedMovementClipset(L,"move_m@drunk@verydrunk",1.0)RemoveClipSet("move_m@drunk@verydrunk")SetTimecycleModifier("spectator5")SetPedIsDrunk(L,true)Wait(15000)a0=false;tvRP.setCanAnim(true)SetPedMotionBlur(L,true)Wait(60000)ClearTimecycleModifier()ResetScenarioTypesEnabled()ResetPedMovementClipset(L,0)SetPedIsDrunk(L,false)SetPedMotionBlur(L,false)end)function getRandomComaAnimation()local a2={{"combat@damage@writheidle_a","writhe_idle_a"},{"combat@damage@writheidle_a","writhe_idle_b"},{"combat@damage@writheidle_a","writhe_idle_c"},{"combat@damage@writheidle_b","writhe_idle_d"},{"combat@damage@writheidle_b","writhe_idle_e"},{"combat@damage@writheidle_b","writhe_idle_f"},{"combat@damage@writheidle_c","writhe_idle_g"},{"combat@damage@rb_writhe","rb_writhe_loop"},{"combat@damage@writhe","writhe_loop"}}local a3={}local a4,a5=table.unpack(a2[math.random(1,#a2)])a3["dict"]=a4;a3["anim"]=a5;return a3 end;local R={}function CMG.getKillerInfo()return R end;function CMG.setEventRespawnPosition(D)n=D end;function CMG.setIgnoreEventRespawns(a6)m=a6 end;Citizen.CreateThread(function()Wait(10000)local a7,a8,a9,aa,s;while true do Citizen.Wait(0)local L=PlayerPedId()if IsEntityDead(L)then Citizen.Wait(500)local A=GetEntityCoords(L,true)local ab=GetEntityRotation(L,2)local ac=GetPedSourceOfDeath(L)a9=GetPedCauseOfDeath(L)aa=WeaponNames[a9]s=q[a9]if a9==`WEAPON_FALL`then ac=L end;if IsEntityAPed(ac)and IsPedAPlayer(ac)then a8=NetworkGetPlayerIndexFromPed(ac)elseif IsEntityAVehicle(ac)and IsEntityAPed(GetPedInVehicleSeat(ac,-1))and IsPedAPlayer(GetPedInVehicleSeat(ac,-1))then a8=NetworkGetPlayerIndexFromPed(GetPedInVehicleSeat(ac,-1))end;local ad=CMG.getPedServerId(ac)if inOrganHeist then TriggerServerEvent("CMG:diedInOrganHeist",ad)CMG.setDeathInOrganHeist()end;if a8==PlayerId()then a7="committed suicide"elseif a8==nil then a7="died"else a7="killed"end;local ae=false;local af=0;if a7=="committed suicide"or a7=="died"then ae=true else local ag=CMG.getPlayerName(a8)R.name=ag;af=#(GetEntityCoords(PlayerPedId())-GetEntityCoords(ac))end;R.source=ad;R.user_id=CMG.getUserId(ad)R.weapon=tostring(aa)R.ready=true;if CMG.inEvent()then TriggerServerEvent("CMG:eventPlayerDeath","killed",s,af,ad)local ah=CreateCameraWithParams("DEFAULT_SCRIPTED_CAMERA",A.x,A.y,A.z+10.0,ab.x,ab.y,ab.z,65.0+0.001,false,2)SetCamActiveWithInterp(ah,GetRenderingCam(),1000,5,5)RenderScriptCams(true,true,3000,true,false)PointCamAtEntity(ah,L,1,1,1,true)ShakeCam(ah,"DEATH_FAIL_IN_EFFECT_SHAKE",0.7)AnimpostfxPlay("DeadlineNeon",3000,false)PlaySoundFrontend(-1,"ScreenFlash","WastedSounds",false)CMG.announceMpBigMsg("~r~WASTED","",3000,true,true)Wait(3000)tvRP.respawnPlayer()if not m then AnimpostfxStop("DeadlineNeon")RenderScriptCams(false,false,1,true,true)DestroyCam(ah,false)end else if B(s)then TriggerEvent("CMG:Revive")TriggerEvent("CMG:knockOut")l=l+1;Citizen.CreateThread(function()Citizen.Wait(1000)C()SetEntityHealth(PlayerPedId(),108)local ai=GetGameTimer()while GetGameTimer()-ai<59000 do if not CMG.isKnockedOut()then return end;Citizen.Wait(0)end;TriggerEvent("CMG:knockOutDisable")end)elseif GetGameTimer()<i+10000 then local ad=CMG.getPedServerId(ac)TriggerServerEvent("CMG:killLog","killed",ad,s,ae,af)TriggerEvent("CMG:onPlayerKilled","killed",ad,tostring(aa))l=0 elseif GetGameTimer()<i+j then local ad=CMG.getPedServerId(ac)TriggerServerEvent("CMG:killLog","finished off",ad,s)j=0;TriggerEvent("CMG:onPlayerKilled","finishedoff",ad,tostring(aa))l=0 end end;a8=nil;a7=nil;a9=nil;aa=nil end;while IsEntityDead(PlayerPedId())do Citizen.Wait(0)end;R={}end end)function tvRP.varyHealth(aj)local F=PlayerPedId()local ak=math.floor(GetEntityHealth(F)+aj)SetEntityHealth(F,ak)end;function tvRP.getHealth()return GetEntityHealth(PlayerPedId())end;function tvRP.setHealth(H)local ak=math.floor(H)SetEntityHealth(PlayerPedId(),ak)end;function CMG.setFriendlyFire(a6)NetworkSetFriendlyFireOption(a6)SetCanAttackFriendly(GetPlayerPed(-1),a6,a6)end;function CMG.setPolice(a6)local N=PlayerId()SetPoliceIgnorePlayer(N,not a6)SetDispatchCopsForPlayer(N,a6)end;AddEventHandler("CMG:onClientSpawn",function(al,am)if am then CMG.setPolice(false)CMG.setFriendlyFire(true)ClearFocus()end end)
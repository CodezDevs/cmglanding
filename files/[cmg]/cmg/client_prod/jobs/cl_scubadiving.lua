local a=module("cfg/cfg_scubadiving")local b={}local c;local d=0;local e=false;local f=""local g=0;local h;local i=false;RMenu.Add("scubadiving","main",RageUI.CreateMenu("","",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight(),"cmg_scubajob","cmg_scubajob"))RMenu:Get("scubadiving","main"):SetSubtitle("~b~Scuba Diving")local function j()RageUI.CloseAll()RageUI.Visible(RMenu:Get('scubadiving','main'),true)end;local function k()RageUI.CloseAll()RageUI.Visible(RMenu:Get('scubadiving','main'),false)end;AddEventHandler("CMG:onClientSpawn",function(l,m)if m then local n=CMG.createDynamicPed(a.jobPedModel,a.jobPedPosition,a.jobPedHeading,true,"mini@strip_club@idles@bouncer@base","base",100,false,function(o)local p=math.random(1,15)SetPedComponentVariation(o,11,243,p,0)SetPedComponentVariation(o,3,123,0,0)SetPedComponentVariation(o,4,94,p,0)SetPedComponentVariation(o,6,67,1,0)SetPedComponentVariation(o,7,40,1,0)SetPedComponentVariation(o,8,15,0,1)SetPedScubaGearVariation(o)end)tvRP.addBlip(a.jobPosition.x,a.jobPosition.y,a.jobPosition.z,308,0,"Scuba Diving")tvRP.addMarker(a.jobPosition.x,a.jobPosition.y,a.jobPosition.z-0.2,0.5,0.5,0.5,0,50,255,170,50,20,false,false,true)local q=function(r)j()end;local s=function(r)k()end;local t=function(r)end;CMG.createArea("scubajob",a.jobPosition,1.5,6,q,s,t,{})end end)RageUI.CreateWhile(1.0,RMenu:Get("scubadiving","main"),nil,function()RageUI.IsVisible(RMenu:Get("scubadiving","main"),true,true,true,function()RageUI.ButtonWithStyle("Request Job","",{RightLabel="→→→"},true,function(u,v,w)if u then end;if v then end;if w then if not e then TriggerServerEvent("CMG:requestScubaDivingJob")end end end)if d~=0 then RageUI.ButtonWithStyle("Claim Reward","",{RightLabel="→→→"},true,function(u,v,w)if u then end;if v then end;if w then TriggerServerEvent("CMG:claimScubaReward",c)d=0;c=nil;e=false;i=false;if DoesEntityExist(g)then DeleteVehicle(g)end;tvRP.setCustomization(h)local x=PlayerPedId()SetEnableScuba(x,false)SetPedMaxTimeUnderwater(x,10.0)CMG.setMaxUnderWaterUITimenewTime(10.0)end end)end end,function()end)end)local function y()for z,A in pairs(b)do tvRP.removeMarker(A.objectMarker)tvRP.removeArea(A.objectArea)if DoesEntityExist(A.objectId)then DeleteEntity(A.objectId)end end;b={}end;local function B(C,D)Citizen.InvokeNative(0x577f790cb611bd49,C,D)end;function startScubaDiving()CMG.loadAnimDict("missheistchem2")local x=PlayerPedId()local E=GetVehiclePedIsIn(x,false)local F=NetworkGetNetworkIdFromEntity(E)local G=GetEntityCoords(E)SetBoatAnchor(E,true)B(E,true)SetVehicleEngineOn(E,false,0,0)ClearPedTasksImmediately(x)local H=CreateSynchronizedScene(0.0,0.0,0.0,0.0,0.0,0.0,2)TaskSynchronizedScene(x,H,"missheistchem2","Boat_Dive_Enter_Player",1000.0,-8.0,4,0,1148846080,0)AttachSynchronizedSceneToEntity(H,E,0)StartAudioScene("FBI_5_DIVE_IN_SYNC_SCENE")while IsSynchronizedSceneRunning(H)and GetSynchronizedScenePhase(H)<1.0 do Wait(0)end;local I=CreateSynchronizedScene(0.0,0.0,0.0,0.0,0.0,0.0,2)TaskSynchronizedScene(x,I,"missheistchem2","Boat_Dive_Idle_Player",8.0,-8.0,4,0,8.0,1024)AttachSynchronizedSceneToEntity(I,E,0)SetSynchronizedSceneLooped(I,1)local J=false;SetPedScubaGearVariation(CMG.getPlayerPed())drawNativeNotification("Press ~INPUT_PICKUP~ to start Scuba Diving.")while not J do if IsControlJustReleased(1,38)then break end;Wait(0)end;SetPlayerControl(PlayerId(),false,256)local I=CreateSynchronizedScene(0.0,0.0,0.0,0.0,0.0,0.0,2)TaskSynchronizedScene(PlayerPedId(),I,"missheistchem2","Boat_Dive_Exit_Player",1000.0,-8.0,4,0,1148846080,0)AttachSynchronizedSceneToEntity(I,E,0)local K=GetGameTimer()local L=false;local M=false;local N=false;SetEnableScuba(x,true)SetPedMaxTimeUnderwater(x,400.0)CMG.setMaxUnderWaterUITimenewTime(400.0)while IsSynchronizedSceneRunning(I)and GetGameTimer()-K<20000 do if GetSynchronizedScenePhase(I)>0.147 and not L then CMG.loadPtfx("scr_fbi5a")StartParticleFxNonLoopedOnEntity("scr_fbi5_ped_water_splash",PlayerPedId(),0.0,0.0,0.0,0.0,0.0,0.0,1065353216,0,0,0)RemoveNamedPtfxAsset("scr_fbi5a")L=true end;if GetSynchronizedScenePhase(I)>0.48 and not M then CMG.loadPtfx("scr_fbi5a")StartParticleFxNonLoopedOnEntity("water_splash_ped_bubbles",PlayerPedId(),0.0,0.0,0.0,0.0,0.0,0.0,1065353216,0,0,0)M=true;DetachEntity(PlayerPedId())RemoveNamedPtfxAsset("scr_fbi5a")end;if GetSynchronizedScenePhase(I)>0.65 and not N then N=true;DetachEntity(PlayerPedId())TaskPlayAnim(PlayerPedId(),"SWIMMING@scuba","dive_run",4.0,-1.5,1000,131081,0,0,0,0)TaskForceMotionState(PlayerPedId(),-1855028596,0)TaskGoStraightToCoord(PlayerPedId(),G.x,G.y,G.z-5.0,-7.5,2,-1,1193033728)SetPlayerControl(PlayerId(),true,256)end;Wait(0)end;RemoveAnimDict("missheistchem2")DisposeSynchronizedScene(I)ClearPedTasksImmediately(x)local O=false;while GetVehiclePedIsIn(PlayerPedId(),false)~=E do if not DoesEntityExist(E)then if not O then print("[Scuba] Boat has left scope. Previous Entity:",E,"NetID:",F)O=true end;if NetworkDoesEntityExistWithNetworkId(F)then E=NetworkGetEntityFromNetworkId(F)print("[Scuba] Boat has come back in to scope. Entity:",E,"NetID:",F)O=false end end;if c==nil then print("[Scuba] Job has ended early without returning onto the boat")return end;Wait(250)end;SetBoatAnchor(E,false)B(E,false)tvRP.notify("~g~Scuba Diving job ended, return to HQ to get paid!")SetNewWaypoint(-2195.6926269531,-394.82040405273)y()if d>6 then d=6 end;TriggerServerEvent("CMG:finishScubaDivingJob",c,d)end;RegisterNetEvent("CMG:createScubaJob",function(P,Q)c=Q;e=true;DoScreenFadeOut(500)Wait(600)local R=AddBlipForRadius(P.position.x,P.position.y,P.position.z,250.0)SetBlipColour(R,30)SetBlipAlpha(R,180)local q=function(r)drawNativeNotification("Press ~INPUT_DETONATE~ to begin diving!")end;local s=function(r)end;local t=function(r)if IsControlJustReleased(1,47)then local x=CMG.getPlayerPed()local S=CMG.getPlayerVehicle()if S~=0 then if GetEntityModel(S)~=`dinghy`then tvRP.notify("~r~You must be in a dinghy to start scuba diving!")else tvRP.removeArea("scubajob_"..P.name)f="~y~Search for treasures and return to your boat when finished"createRewardObjects(P)CreateThread(startScubaDiving)end else tvRP.notify("~r~You must be in a boat to start scuba diving!")end end end;SetWaypointOff()local T=tvRP.addBlip(P.position.x,P.position.y,P.position.z,P.blipId,P.blipColour,"Scuba Diving")SetNewWaypoint(P.position.x,P.position.y)CMG.createArea("scubajob_"..P.name,P.position,250,15,q,s,t,{})h=tvRP.getCustomization()tvRP.setCustomization({modelhash=`mp_m_freemode_01`})local p=math.random(1,15)local U=PlayerPedId()SetPedComponentVariation(PlayerPedId(),11,243,p,0)SetPedComponentVariation(PlayerPedId(),3,123,0,0)SetPedComponentVariation(PlayerPedId(),4,94,p,0)SetPedComponentVariation(PlayerPedId(),6,67,1,0)SetPedComponentVariation(PlayerPedId(),7,40,1,0)SetPedComponentVariation(PlayerPedId(),8,15,0,1)SetPedScubaGearVariation(PlayerPedId())Wait(0)local V=math.random(#P.dinghySpawnPositions)SetEntityCoords(PlayerPedId(),P.dinghySpawnPositions[V])g=CMG.spawnVehicle(`dinghy`,P.dinghySpawnPositions[V].x,P.dinghySpawnPositions[V].y,P.dinghySpawnPositions[V].z,P.dinghySpawnHeading,true,true,true)local W=AddBlipForEntity(g)SetBlipSprite(W,427)SetBlipDisplay(W,4)SetBlipScale(W,1.0)SetBlipColour(W,2)SetBlipAsShortRange(W,true)BeginTextCommandSetBlipName("STRING")AddTextComponentSubstringPlayerName("Scuba Dinghy")EndTextCommandSetBlipName(W)Wait(2000)local X=NetworkGetNetworkIdFromEntity(g)TriggerServerEvent("CMG:scubaSetVehicle",c,X)DoScreenFadeIn(2000)SetPedScubaGearVariation(PlayerPedId())Citizen.CreateThread(function()while e do if i then drawPlaneScaleForm("~r~MISSION FAILED","Your boat has been destroyed, go get a new one!")SetWaypointOff()TriggerServerEvent("CMG:finishScubaDivingJob",c,0)TriggerServerEvent("CMG:claimScubaReward",c)d=0;c=nil;e=false;i=false;tvRP.setCustomization(h)local x=PlayerPedId()SetEnableScuba(x,false)SetPedMaxTimeUnderwater(x,10.0)CMG.setMaxUnderWaterUITimenewTime(10.0)y()break end;Wait(250)end end)f="~y~Head to the diving location: "..P.name;while e do drawNativeText(f)Wait(0)end;tvRP.removeBlip(T)RemoveBlip(R)end)RegisterNetEvent("CMG:scubaBoatDestroyed",function(Y)if e and Y==c then i=true end end)function createRewardObjects(P)for z,A in pairs(P.rewardObjects)do local Z=CMG.loadModel(A.objectModel)local _=CreateObject(Z,A.objectPosition.x,A.objectPosition.y,A.objectPosition.z,false,true,false)SetModelAsNoLongerNeeded(Z)local a0=tvRP.addMarker(A.objectPosition.x,A.objectPosition.y,A.objectPosition.z+0.6,0.5,0.5,0.5,255,223,0,150,50.0,0,false,true,true)local q=function(r)drawNativeNotification("Press ~INPUT_PICKUP~ to collect!")end;local s=function(r)end;local t=function(r)if IsControlJustReleased(1,38)and e then tvRP.notify("~g~Item collected.")d=d+1;tvRP.removeMarker(b[r.objectId].objectMarker)tvRP.removeArea(b[r.objectId].objectArea)DeleteEntity(b[r.objectId].objectId)b[r.objectId].objectMarker=nil;b[r.objectId].objectArea=nil;b[r.objectId].objectId=nil end end;CMG.createArea("scubajob_"..P.name.."_obj_"..z,A.objectPosition,3.0,3.0,q,s,t,{objectId=z})b[z]={}b[z].objectId=_;b[z].objectMarker=a0;b[z].objectArea="scubajob_"..P.name.."_obj_"..z end end;RegisterCommand("createscuba",function(a1,a2)local a3=GetHashKey(a2[1])print("propHash",a3)RequestModel(a3)while not HasModelLoaded(a3)do Wait(0)end;local a4=GetEntityCoords(CMG.getPlayerPed())local a5=CreateObject(a3,a4.x,a4.y,a4.z-1,false,false,true)SetEntityInvincible(a5,true)FreezeEntityPosition(a5,true)SetEntityAlpha(a5,100)SetModelAsNoLongerNeeded(a3)local a6=true;while a6 do local a7=GetEntityCoords(a5)local a8=GetEntityHeading(a5)if IsControlPressed(0,121)then SetEntityCoordsNoOffset(a5,a7.x,a7.y,a7.z+0.01)end;if IsControlPressed(0,178)then SetEntityCoordsNoOffset(a5,a7.x,a7.y,a7.z-0.01)end;if IsControlPressed(0,111)then SetEntityCoordsNoOffset(a5,a7.x,a7.y+0.01,a7.z)end;if IsControlPressed(0,110)then SetEntityCoordsNoOffset(a5,a7.x,a7.y-0.01,a7.z)end;if IsControlPressed(0,108)then SetEntityCoordsNoOffset(a5,a7.x-0.01,a7.y,a7.z)end;if IsControlPressed(0,107)then SetEntityCoordsNoOffset(a5,a7.x+0.01,a7.y,a7.z)end;if IsControlPressed(0,117)then SetEntityHeading(a5,a8+0.1)end;if IsControlPressed(0,118)then SetEntityHeading(a5,a8-0.1)end;if IsControlJustPressed(0,177)then print("objectModel = `"..a2[1].."`,")print("objectPosition = "..a7 ..",")print("objectRotation = "..a8 ..",")print(a7,a8)SetEntityAlpha(a5,255)SetTimeout(60000,function()DeleteEntity(a5)end)a6=false end;Wait(0)end end)
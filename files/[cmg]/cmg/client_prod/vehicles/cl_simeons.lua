local a={}local b={}local c={}local d;local e;local f=0;local g=0;local h=false;local i;local j;local k=false;local l=module("cfg/cfg_simeons")RegisterNetEvent("CMG:gotCarDealerInstances",function(m)a=m end)RegisterNetEvent("CMG:gotCarDealerCategories",function(n)b=n end)RegisterNetEvent("CMG:carDealerPurchased",function()DeleteVehicle(f)f=0;g=0;h=false;local o=a[d].posVector;SetEntityCoords(CMG.getPlayerPed(),o.x,o.y,o.z)end)local function p(q)if q~=nil then d=q end;RageUI.Visible(RMenu:Get('cardealer','mainmenu'),true)end;local function r(q)RageUI.Visible(RMenu:Get('cardealer','mainmenu'),false)d=nil end;local function s(t,u,v,w)DeleteVehicle(GetVehiclePedIsIn(CMG.getPlayerPed(),false))local x=GetHashKey(t)RequestModel(x)local y=0;while not HasModelLoaded(x)and y<100 do Citizen.Wait(10)y=y+1 end;if HasModelLoaded(x)then local z=CreateVehicle(x,u,v,w,GetEntityHeading(CMG.getPlayerPed()),false,false)DecorSetInt(z,"CMGACVeh",955)SetEntityAsMissionEntity(z)FreezeEntityPosition(z,true)SetEntityInvincible(z,true)SetVehicleDoorsLocked(z,4)SetModelAsNoLongerNeeded(x)TaskWarpPedIntoVehicle(CMG.getPlayerPed(),z,-1)Citizen.CreateThread(function()while DoesEntityExist(z)do Citizen.Wait(25)SetEntityHeading(z,GetEntityHeading(z)+1%360)end end)h=true;return z else tvRP.notify("~r~Could not load vehicle")return-1 end end;CreateThread(function()for A,B in pairs(l.simeonsInstances)do local C,D,E,F,G,H,I=B.posVector,B.blipId,B.blipColour,B.markerId,B.markerColourTable,B.permissionsTable,B.categorys;tvRP.addBlip(C.x,C.y,C.z,D,E)tvRP.addMarker(C.x,C.y,C.z,0.7,0.7,0.5,G[1],G[2],G[3],125,50,F,true,true)end end)Citizen.CreateThread(function()while true do if a~=nil then for A,B in pairs(a)do local C,J,D,E,F,G,H,I=B.posVector,B.previewVector,B.blipId,B.blipColour,B.markerId,B.markerColourTable,B.permissionsTable,B.categorys;if c[A]~=nil then if c[A]<2.0 then TriggerServerEvent("CMG:refreshSimeonsPermissions")p(A)while c[A]<2.0 or h or isNearPreviewVector(J)or k do Wait(0)end;r(A)end end end end;Wait(0)end end)RegisterCommand("debugsimeons",function()for A,B in pairs(a)do print("carDealerInstanceDistances[carDealer]",c[A])end end)RegisterCommand("debugsimeons2",function()if CMG.getUserId()==1 then print(dump(a))end end)RegisterCommand("debugsimeons3",function()if CMG.getUserId()==1 then p("Simeons")end end)function isNearPreviewVector(J)if#(GetEntityCoords(CMG.getPlayerPed())-J)<5.0 then return true end;return false end;Citizen.CreateThread(function()while true do if a~=nil then for A,B in pairs(a)do local C,D,E,F,G,H,I=B.posVector,B.blipId,B.blipColour,B.markerId,B.markerColourTable,B.permissionsTable,B.categorys;c[A]=#(GetEntityCoords(CMG.getPlayerPed())-C)end end;Wait(250)end end)local function K(L)local M={}for N,O in pairs(L)do if N~="_config"then table.insert(M,{N,O})end end;table.sort(M,function(P,Q)return P[2][2]<Q[2][2]end)local R=0;return function()R=R+1;if M[R]then return M[R][1],M[R][2]else return nil,nil end end end;RMenu.Add('cardealer','mainmenu',RageUI.CreateMenu("","",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight(),"cmg_simeonsui","cmg_simeonsui"))RMenu:Get('cardealer','mainmenu'):SetSubtitle("~b~Categories")RMenu.Add('cardealer','categories',RageUI.CreateSubMenu(RMenu:Get('cardealer','mainmenu'),"","~b~Vehicles",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight()))RMenu.Add('cardealer','vehicle',RageUI.CreateSubMenu(RMenu:Get('cardealer','categories'),"","~b~Options",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight()))RMenu.Add('cardealer','confirm',RageUI.CreateSubMenu(RMenu:Get('cardealer','vehicle'),"","~b~Are you sure?",CMG.getRageUIMenuWidth(),CMG.getRageUIMenuHeight()))RageUI.CreateWhile(1.0,RMenu:Get('cardealer','mainmenu'),nil,function()RageUI.IsVisible(RMenu:Get('cardealer','mainmenu'),true,true,true,function()if d~=nil then for A,B in pairs(a)do if d==A then local S=B.categorys;for T,U in pairs(S)do RageUI.ButtonWithStyle(U,"",{RightLabel="→→→"},true,function(V,W,X)if V then end;if W then end;if X then e=U end end,RMenu:Get('cardealer','categories'))end end end end end,function()end)RageUI.IsVisible(RMenu:Get('cardealer','categories'),true,true,true,function()if d~=nil then for A,B in pairs(a)do if d==A then local C,J,D,E,F,G,H,I=B.posVector,B.previewVector,B.blipId,B.blipColour,B.markerId,B.markerColourTable,B.permissionsTable,B.categorys;local S=B.categorys;for T,U in pairs(S)do if e==U then if b[U]~=nil then for N,O in K(b[U])do if N~="_config"then RageUI.ButtonWithStyle(O[1],"Boot size ("..O[3].."kg)",{RightLabel="£"..getMoneyStringFormatted(O[2])},true,function(V,W,X)if V then end;if W then if f==0 or g~=N then DeleteVehicle(f)f=s(N,J.x,J.y,J.z)g=N end end;if X then j=N;i=O end end,RMenu:Get('cardealer','vehicle'))end end else RageUI.ButtonWithStyle("~r~No permission","",{RightLabel=""},true,function(V,W,X)if V then end;if W then end;if X then end end,RMenu:Get('cardealer','categories'))end end end end end end end,function()end)RageUI.IsVisible(RMenu:Get('cardealer','vehicle'),true,false,false,function()if d~=nil then RageUI.ButtonWithStyle("Purchase "..i[1],"",{RightLabel="→→→"},true,function(V,W,X)if V then end;if W then end;if X then end end,RMenu:Get('cardealer','confirm'))RageUI.ButtonWithStyle("Test Drive "..i[1],"",{RightLabel="→→→"},true,function(V,W,X)if V then end;if W then end;if X then DeleteVehicle(GetVehiclePedIsIn(CMG.getPlayerPed()))if not k then RageUI.CloseAll()hash=GetHashKey(j)while not HasModelLoaded(hash)do RequestModel(hash)Citizen.Wait(10)end;if HasModelLoaded(hash)then k=true;DeleteEntity(f)local Y=vector3(-914.83026123046,-3287.1538085938,13.521618843078)if IsThisModelABoat(hash)then Y=vector3(-330.306,-3366.949,0.953)end;testDriveCar=CreateVehicle(hash,Y.x,Y.y,Y.z,60.962993621826,false,false)testDriveSeconds=60;local Z=GetEntityCoords(CMG.getPlayerPed())DecorSetInt(testDriveCar,"CMGACVeh",955)SetModelAsNoLongerNeeded(hash)TaskWarpPedIntoVehicle(CMG.getPlayerPed(),testDriveCar,-1)setVehicleFuel(testDriveCar,100)tvRP.notify("~g~You have 1 minute to test drive this vehicle!")for R=0,24 do SetVehicleModKit(testDriveCar,0)RemoveVehicleMod(testDriveCar,R)end;SetTimeout(60000,function()if k then DeleteVehicle(GetVehiclePedIsIn(CMG.getPlayerPed()))DeleteVehicle(testDriveCar)SetEntityCoords(CMG.getPlayerPed(),Z.x,Z.y,Z.z)tvRP.notify("~b~Test drive over!")p()end end)Citizen.CreateThread(function()while k do testDriveSeconds=testDriveSeconds-1;Wait(1000)end end)Citizen.CreateThread(function()while k do if testDriveSeconds<60 then CMG.DrawText(1.30-1.0/2,1.40-1.0/2+0.005,"~y~"..testDriveSeconds.." seconds left.",0.35)end;Wait(0)end end)Citizen.CreateThread(function()while k do local _=GetVehiclePedIsIn(CMG.getPlayerPed(),false)if _~=nil then if testDriveCar~=_ then DeleteVehicle(GetVehiclePedIsIn(CMG.getPlayerPed()))DeleteVehicle(testDriveCar)SetEntityCoords(CMG.getPlayerPed(),Z.x,Z.y,Z.z)tvRP.notify("~b~Test drive over!")k=false;p()end end;Wait(0)end end)end end end end)end end,function()end)RageUI.IsVisible(RMenu:Get('cardealer','confirm'),true,false,false,function()RageUI.ButtonWithStyle("Yes","",{RightLabel="→→→"},true,function(V,W,X)if V then end;if W then end;if X then TriggerServerEvent("CMG:purchaseCarDealerVehicle",e,j)end end,RMenu:Get('cardealer','mainmenu'))RageUI.ButtonWithStyle("No","",{RightLabel="→→→"},true,function(V,W,X)if V then end;if W then end;if X then tvRP.notify("~y~Cancelled!")end end,RMenu:Get('cardealer','mainmenu'))end,function()end)end)function func_previewSimeonsVehicle()if h then if IsControlJustPressed(0,177)then while DoesEntityExist(f)do DeleteVehicle(f)Wait(50)end;f=0;g=0;h=false end end end;CMG.createThreadOnTick(func_previewSimeonsVehicle)
local a=module("cfg/events/cfg_tilesurprise")local b=vector3(-3947.41,-1712.07,629.52)local c={{"red","~r~"},{"blue","~b~"},{"purple","~p~"},{"black","~c~"},{"white","~y~"},{"grey","~m~"},{"yellow","~y~"},{"orange","~o~"},{"green","~g~"},{"pink","~y~"}}local d={}local e=CMG.createTimerBars()local function f()local g=PlayerPedId()local h=GetVehiclePedIsUsing(g)local i=GetEntityCoords(g)local j=GetEntityRotation(g,2)local k=CreateCameraWithParams("DEFAULT_SCRIPTED_CAMERA",i.x,i.y,i.z+10.0,j.x,j.y,j.z,65.0+0.001,0,2)SetCamActiveWithInterp(k,GetRenderingCam(),1000,5,5)RenderScriptCams(true,true,3000,1,0)PointCamAtEntity(k,h,1,1,1,true)ShakeCam(k,"DEATH_FAIL_IN_EFFECT_SHAKE",0.7)AnimpostfxPlay("DeadlineNeon",3000,false)PlaySoundFrontend(-1,"ScreenFlash","WastedSounds",false)CMG.announceMpBigMsg("~r~WASTED","",3000,true,true)local l=d.round;TaskLeaveVehicle(g,h,16)ClearPedTasksImmediately(g)SetEntityCoordsNoOffset(g,d.position.x,d.position.y,d.position.z,true,false,false)FreezeEntityPosition(g,true)SetEntityVisible(g,false,false)SetEntityCollision(g,false,false)while d.round==l do Citizen.Wait(0)end;g=PlayerPedId()FreezeEntityPosition(g,false)SetEntityVisible(g,true,true)SetEntityCollision(g,true,true)AnimpostfxStop("DeadlineNeon")RenderScriptCams(false,false,0,false,false)DestroyCam(k,0)end;local function m(n)local o=GetPlayerFromServerId(n.source)if o~=-1 then local p=CMG.getPlayerName(o)return string.format("%s (Lives: %d)",p,n.lives or-1)end;return"Unknown (Lives: -1)"end;local function q(r,s,t,u)if not d.walls[s]then d.walls[s]={}end;if t==1 then local v=CreateObjectNoOffset(`cmgraceblock`,r.x+t*7.25-4.0,r.y+u*8.0,r.z+4.0,false,true,false)SetEntityRotation(v,0.0,90.0,0.0,2,true)SetObjectTextureVariation(v,9)table.insert(d.walls[s],v)end;if t==12 then local v=CreateObjectNoOffset(`cmgraceblock`,r.x+t*7.25+4.0,r.y+u*8.0,r.z+4.0,false,true,false)SetEntityRotation(v,0.0,90.0,0.0,2,true)SetObjectTextureVariation(v,9)table.insert(d.walls[s],v)end;if u==1 then local v=CreateObjectNoOffset(`cmgraceblock`,r.x+t*7.25,r.y+u*8.0-4.3,r.z+3.625,false,true,false)SetEntityRotation(v,90.0,0.0,0.0,2,true)SetObjectTextureVariation(v,9)table.insert(d.walls[s],v)end;if u==12 then local v=CreateObjectNoOffset(`cmgraceblock`,r.x+t*7.25,r.y+u*8.0+4.3,r.z+3.625,false,true,false)SetEntityRotation(v,90.0,0.0,0.0,2,true)SetObjectTextureVariation(v,9)table.insert(d.walls[s],v)end end;local function w(x)local y=GetEntityCoords(PlayerPedId(),true)if d.map then for z,A in ipairs(d.map)do for B,C in ipairs(A)do for B,D in ipairs(C)do if D.colour~=x then ActivatePhysics(D.object)FreezeEntityPosition(D.object,false)ApplyForceToEntity(D.object,1,0.0,0.0,math.random(10,30)+0.0,math.random()-0.5,math.random()-0.5,math.random()-0.5,0,false,false,true,false,true)end end;if z==1 then AddExplosion(y.x,y.y,y.z-10.0,math.random(0,80),0.0,true,true,0.0)end end end end;if d.walls then for z,A in ipairs(d.walls)do for B,E in ipairs(A)do ActivatePhysics(E)FreezeEntityPosition(E,false)ApplyForceToEntity(E,1,0.0,0.0,1.0,math.random()-0.5,math.random()-0.5,math.random()-0.5,0,false,false,true,false,true)end end end end;local function F(G)CMG.loadModel(`cmgraceblock`)if d.map then for B,s in ipairs(d.map)do for B,C in ipairs(s)do for B,D in ipairs(C)do DeleteObject(D.object)end end end end;if d.walls then for B,A in ipairs(d.walls)do for B,E in ipairs(A)do DeleteObject(E)end end end;d.map={}d.walls={}for s=1,1 do d.map[s]={}for t=1,12 do d.map[s][t]={}for u=1,12 do local H=(s-1)*200.0;local E=CreateObjectNoOffset(`cmgraceblock`,b.x+t*7.25,b.y+u*8.0,b.z-H,false,true,false)local I=G and G[t*12+u-12]or math.random(1,10)SetObjectTextureVariation(E,I)SetEntityRotation(E,0.0,0.0,0.0,2,true)q(vector3(b.x,b.y,b.z-H),s,t,u)d.map[s][t][u]={object=E,colour=I}end end end end;local function J(K)SetPedIntoVehicle(PlayerPedId(),d.vehicle,-1)local L=GetGameTimer()local M=d;while not NetworkHasControlOfEntity(d.vehicle)and GetGameTimer()-L<2000 do Citizen.Wait(0)if M~=d then return end end;if d.position==nil then print("[Tile Surprise] Deleting vehicle on spawn, no position was set.")DeleteEntity(d.vehicle)return end;SetEntityCoordsNoOffset(d.vehicle,d.position.x,d.position.y,d.position.z+1.0,true,false,false)SetVehicleOnGroundProperly(d.vehicle)if not K then FreezeEntityPosition(d.vehicle,true)end;SetVehRadioStation(d.vehicle,"OFF")SetVehicleRadioEnabled(d.vehicle,false)SetDisableVehicleEngineFires(d.vehicle,true)SetDisableVehiclePetrolTankFires(d.vehicle,true)Citizen.CreateThreadNow(function()local N=-1;local O=-1;while N~=d.colour or O~=d.colour do SetVehicleColours(d.vehicle,d.colour,d.colour)N,O=GetVehicleColours(d.vehicle)Citizen.Wait(0)end end)end;RegisterNetEvent("CMG:tilesVehicleSpawned",function(P,K)d.hasFailed=false;if DoesEntityExist(d.vehicle)then DeleteEntity(d.vehicle)end;local M=d;while not DoesEntityExist(d.vehicle)do if NetworkDoesEntityExistWithNetworkId(P)then d.vehicle=NetworkGetEntityFromNetworkId(P)end;Citizen.Wait(0)if d~=M then return end end;while not NetworkHasControlOfEntity(d.vehicle)or GetPedInVehicleSeat(d.vehicle,-1)~=PlayerPedId()do Citizen.Wait(0)if d~=M then return end end;J(K)end)local function Q()DisableControlAction(0,23,true)DisableControlAction(0,75,true)DisableControlAction(0,24,true)DisableControlAction(0,25,true)DisableControlAction(0,37,true)DisableControlAction(0,12,true)DisableControlAction(0,13,true)DisableControlAction(0,14,true)DisableControlAction(0,15,true)DisableControlAction(0,16,true)DisableControlAction(0,17,true)DisableControlAction(0,53,true)DisableControlAction(0,54,true)DisableControlAction(0,99,true)DisableControlAction(0,100,true)DisableControlAction(0,261,true)DisableControlAction(0,262,true)end;local function R()local S=#CMG.getActiveEventPlayers()local T=#currentEvent.players-S;e.push("~y~ELIMINATED~w~",tostring(T))e.push("~y~REMAINING~w~",tostring(S))e.push("~y~ROUND~w~",tostring(d.round))end;local function U()for B,n in ipairs(GetActivePlayers())do local V=GetPlayerPed(n)if V~=0 then local W=GetVehiclePedIsUsing(V)if W~=0 then if HasEntityBeenDamagedByEntity(d.vehicle,W,true)then d.lastDamagedVehicle=W;d.lastDamagedVehicleTime=GetGameTimer()end;SetVehicleHandlingFloat(W,"CHandlingData","fMass",1500.0)ClearEntityLastDamageEntity(W)end end end end;local function X()if d.lastDamagedVehicle then local Y=GetPedInVehicleSeat(d.lastDamagedVehicle,-1)local o=NetworkGetPlayerIndexFromPed(Y)return GetPlayerServerId(o)end;return nil end;local function Z()CMG.hideUI()if not DoesEntityExist(d.vehicle)then local W=CMG.getPlayerVehicle()if W~=0 then d.vehicle=W else if#(CMG.getPlayerCoords()-b)>100.0 then SetEntityCoordsNoOffset(PlayerPedId(),b.x,b.y,b.z,false,false,false)end end end;e.reset()R()U()ClearEntityLastDamageEntity(d.vehicle)if d.lastDamagedVehicle and GetGameTimer()-d.lastDamagedVehicleTime>5000 then d.lastDamagedVehicle=nil end;local _=CMG.getEventLocalPlayer()if _ and _.active then Q()SetPlayerControl(PlayerId(),true,0)local a0=GetVehiclePedIsUsing(PlayerPedId())if a0~=0 then if GetEntityHealth(PlayerPedId())<=0 or GetEntityHealth(a0)<=0 then if not d.hasFailed then TriggerServerEvent("CMG:tilesClientFailed")Citizen.CreateThreadNow(f)d.hasFailed=true end end;FreezeEntityPosition(a0,false)SetVehicleEngineOn(a0,true,true,false)SetVehicleColours(a0,d.colour,d.colour)end;local a1=GetEntityCoords(PlayerPedId(),true)if a1.z<625.0 and not d.hasFailed then TriggerServerEvent("CMG:tilesClientFailed",X())Citizen.CreateThreadNow(f)d.hasFailed=true end;e.push("~y~LIVES~w~",tostring(_.lives))end;if d.counter~=nil then e.push("~r~COUNTDOWN~W~",tostring(d.counter))end;e.draw()end;RegisterNetEvent("CMG:tilesLoad",function(p,a2)currentEvent.drawPlayersTimeBar=false;SetPlayerControl(PlayerId(),false,0)local a3=a.locations[p]d.colour=1;d.vehicles=a3.vehicles;d.confirmedCharacter=false;d.hasFailed=false;d.lastDamagedVehicle=nil;d.lastDamagedVehicleTime=0;d.position=a3.spawnpoints[a2]assert(d.position,string.format("Invalid spawnIndex %s provided to client",tostring(a2)))SetEntityCoordsNoOffset(PlayerPedId(),d.position.x,d.position.y,d.position.z,true,false,false)FreezeEntityPosition(PlayerPedId(),true)SetEntityHeading(PlayerPedId(),d.position.w)RequestScriptAudioBank("DLC_STUNT/STUNT_RACE_01",false)RequestScriptAudioBank("DLC_STUNT/STUNT_RACE_02",false)RequestScriptAudioBank("DLC_STUNT/STUNT_RACE_03",false)CMG.setEventMusic("FAM2_NEAR_YACHT")CMG.loadPtfx("core")CMG.setIgnoreEventRespawns(true)F(nil)end)RegisterNetEvent("CMG:tilesSelect",function(a4)CMG.stopEventSequence()CMG.hideUI()BusyspinnerOff()SetPlayerControl(PlayerId(),true,0)SetEntityVisible(PlayerPedId(),true,false)CMG.startVehicleSelection(a4.xyz,a4.w,d.vehicles,20,function(a5)TriggerServerEvent("CMG:tilesSetVehicle",a5)end,function(I)d.colour=I end)d.stage="SELECT"d.position=a4;while d.stage=="SELECT"do local W=GetVehiclePedIsUsing(PlayerPedId())if W~=0 then FreezeEntityPosition(W,true)end;Citizen.Wait(0)end end)RegisterNetEvent("CMG:tilesStartRound",function(G,l)d.round=l;if l==1 then CMG.endVehicleSelection()SetFollowPedCamViewMode(2)if DoesEntityExist(d.vehicle)then DeleteEntity(d.vehicle)end;for B,n in ipairs(currentEvent.players)do n.lives=3 end;for B,n in pairs(GetActivePlayers())do SetEntityVisible(GetPlayerPed(n),true,0)end;Citizen.CreateThreadNow(function()while d.stage=="SELECT"or d.stage=="BEFORE_START"do Q()local a6=GetVehiclePedIsUsing(PlayerPedId())if a6~=0 then FreezeEntityPosition(a6,true)end;Citizen.Wait(0)end end)end;F(G)AnimpostfxPlay("MinigameEndNeutral",0,false)SetVehicleFixed(d.vehicle)if l~=1 then PlaySoundFrontend(-1,"Deliver_Item","GTAO_Biker_Modes_Soundset",false)end;local _=CMG.getEventLocalPlayer()if _ and _.active then if l==1 then CMG.setEventIntroMessage("TILE SURPRISE","Remain safely on a tile and knock opponents off",3000)else CMG.announceMpBigMsg("Round "..tostring(l),"",3000)end end;if l==1 then CMG.hideUI()d.stage="BEFORE_START"CMG.showCountdownTimer(3)if d.stage~="BEFORE_START"then return end;FreezeEntityPosition(d.vehicle,false)CMG.enableEventPlayerTags(true,false,nil,m)CMG.setPlayerCanOpenLeaderboard(true)d.stage="START"while d.stage=="START"do Z()Citizen.Wait(0)end end end)RegisterNetEvent("CMG:tilesFlipTiles",function(x,a7)local a8=c[x]Citizen.CreateThreadNow(function()PlaySoundFrontend(-1,"Crates_Blipped","GTAO_Biker_Modes_Soundset",false)CMG.announceMpBigMsg("Head to a "..a8[2]..a8[1].."~w~ tile","",2000)end)if d.walls then for B,A in ipairs(d.walls)do for B,E in ipairs(A)do SetObjectTextureVariation(E,x)end end end;local r=GetGameTimer()d.counter=a7;while d.counter do if GetGameTimer()-r>1000 then d.counter=d.counter-1;r=GetGameTimer()if d.counter==0 then d.counter=nil;break else PlaySoundFrontend(-1,"Checkpoint_Buzz","DLC_AW_Frontend_Sounds",false)end end;drawNativeText("Head to a "..a8[2]..a8[1].."~w~ tile")Citizen.Wait(0)end;w(x)ShakeGameplayCam("MEDIUM_EXPLOSION_SHAKE",1.0)end)RegisterNetEvent("CMG:tilesPlayerLostLife",function(a9,I,aa,p,ab,ac)if aa==0 then if ab and ac then notify(I..p.." ~w~has been eliminated by "..ab..ac.."~w~!")else notify(I..p.." ~w~has been eliminated!")end else local ad=aa>1 and"lives"or"life"if ab and ac then notify(string.format("%s%s~w~ has been knocked out by %s%s~w~! (%d %s remaining)",I,p,ab,ac,aa,ad))else notify(string.format("%s%s~w~ has %d %s remaining!",I,p,aa,ad))end end;for B,n in ipairs(currentEvent.players)do if n.source==a9 then n.lives=aa;if n.tag then RemoveMpGamerTag(n.tag)n.tag=nil end;break end end end)Citizen.CreateThread(function()for ae,af in pairs(a.locations)do local ag=nil;CMG.registerEventMenuItem("Tile Surprise",ae,function()if not currentEvent.isActive then RageUI.Separator("Minimum Players: "..tostring(a.minPlayers))RageUI.Separator("Maximum Players: "..tostring(#af.spawnpoints))local ah={RightLabel=not ag and"~y~DEFAULT"or ag}RageUI.ButtonWithStyle("Vehicle Selection","Enter a specific vehicle to use or leave empty to use default.",ah,true,function(ai,aj,ak)if ak then CMG.clientPrompt("Enter Spawncode","",function(al)ag=#al>=3 and string.upper(al)or nil end)end end)RageUI.ButtonWithStyle("Start Event",nil,{RightLabel="→→→"},true,function(ai,aj,ak)if ak then TriggerServerEvent("CMG:startEvent","Tile Surprise",ae,a.minPlayers,#af.spawnpoints,{customSpawncode=ag})end end)end end)CMG.registerEventCleanupHandler(ae,function()if d.map then for B,A in ipairs(d.map)do for B,C in ipairs(A)do for B,D in ipairs(C)do DeleteObject(D.object)end end end end;if d.walls then for B,A in ipairs(d.walls)do for B,E in ipairs(A)do DeleteObject(E)end end end;CMG.enableEventPlayerTags(false,false)CMG.setIgnoreEventRespawns(false)ReleaseNamedScriptAudioBank("DLC_STUNT/STUNT_RACE_01")ReleaseNamedScriptAudioBank("DLC_STUNT/STUNT_RACE_02")ReleaseNamedScriptAudioBank("DLC_STUNT/STUNT_RACE_03")TriggerMusicEvent("BST_STOP")RemoveNamedPtfxAsset("core")CMG.setPlayerCanOpenLeaderboard(false)DeleteEntity(d.vehicle)if not CMG.isPodiumDrawing()then CMG.showUI()end;BusyspinnerOff()SetPlayerControl(PlayerId(),true,0)d={}end)end end)
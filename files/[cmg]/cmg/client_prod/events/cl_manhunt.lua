local a=module("cfg/events/cfg_manhunt")local b={}local c=CMG.createTimerBars()local function d()SetPedIntoVehicle(PlayerPedId(),b.vehicle,-1)local e=GetGameTimer()local f=b;while not NetworkHasControlOfEntity(b.vehicle)and GetGameTimer()-e<2000 do Citizen.Wait(0)if f~=b then return end end;if b.position==nil then print("[Manhunt] Deleting vehicle on spawn, no position was set.")DeleteEntity(b.vehicle)return end;SetEntityCoordsNoOffset(b.vehicle,b.position.x,b.position.y,b.position.z,true,false,false)SetVehicleOnGroundProperly(b.vehicle)FreezeEntityPosition(b.vehicle,true)SetVehRadioStation(b.vehicle,"OFF")SetVehicleRadioEnabled(b.vehicle,false)end;local function g(h)local i=0;for j,k in pairs(currentEvent.players)do if k.team==h then i=i+1 end end;return i end;RegisterNetEvent("CMG:manhuntVehicleSpawned",function(l)local f=b;while not DoesEntityExist(b.vehicle)do if NetworkDoesEntityExistWithNetworkId(l)then b.vehicle=NetworkGetEntityFromNetworkId(l)end;Citizen.Wait(0)if f~=b then return end end;d()end)RegisterNetEvent("CMG:manhuntLoad",function(m,n,o)b={}currentEvent.drawPlayersTimeBar=false;SetPlayerControl(PlayerId(),false,0)local p=a.locations[m]b.vehicles=p.vehicles;b.bounds=p.bounds;CMG.setEventMusic("AH3B_EVADE_COPS_RT")loadMap(n)local q=PlayerPedId()SetEntityCoordsNoOffset(q,o.x,o.y,o.z,true,false,false)SetEntityHeading(q,o.w)end)RegisterNetEvent("CMG:manhuntSelect",function(r)CMG.stopEventSequence()BusyspinnerOff()SetPlayerControl(PlayerId(),true,0)CMG.startVehicleSelection(r.xyz,r.w,b.vehicles,20,function(s)TriggerServerEvent("CMG:manhuntSetVehicle",s)end,nil)b.state="SELECT"b.position=r;CMG.setEventRespawnPosition(r)end)local function t(u)for j,k in pairs(currentEvent.players)do if k.source==u then if k.team=="civilian"then return 3 else return 1 end end end end;local function v(u)for j,k in pairs(currentEvent.players)do if k.source==u then if k.team=="civilian"then return 9 else return 6 end end end end;RegisterNetEvent("CMG:manhuntStart",function()CMG.endVehicleSelection()SetFollowPedCamViewMode(2)ExecuteCommand("showui")CMG.enableEventPlayerBlips(true,t)CMG.enableEventPlayerTags(true,false,v)b.state="BEFORE_START"CMG.showCountdownTimer(3)if b.state~="BEFORE_START"then return end;CMG.setPlayerCanOpenLeaderboard(true)CMG.setEventBounds(b.bounds)b.state="START"b.startTime=GetGameTimer()end)local function w(k)local x=GetPlayerFromServerId(k.source)if b.state~="START"or x==-1 then return end;local y=GetPlayerPed(x)if y==0 then return end;local z=GetVehiclePedIsUsing(y)if z==0 then return end;Citizen.CreateThreadNow(function()CMG.loadPtfx("scr_as_trans")UseParticleFxAsset("scr_as_trans")local A=StartParticleFxLoopedOnEntity("scr_as_trans_smoke",z,0.0,0.0,0.0,0.0,0.0,0.0,2.0,false,false,false)SetParticleFxLoopedColour(A,1.0,0.0,0.0,false)Citizen.Wait(3000)StopParticleFxLooped(A)RemoveNamedPtfxAsset("scr_as_trans")end)end;local function B(k)if k.blip then RemoveBlip(k.blip)k.blip=nil end;if k.tag then RemoveMpGamerTag(k.tag)k.tag=nil end end;RegisterNetEvent("CMG:manhuntSetHunters",function(C)for j,k in pairs(currentEvent.players)do if table.has(C,k.source)then if k.team~="hunter"then k.team="hunter"B(k)w(k)end else if k.team~="civilian"then k.team="civilian"B(k)w(k)end end end end)local function D()SetCurrentPedWeapon(PlayerPedId(),`WEAPON_UNARMED`,true)DisableControlAction(0,21,true)DisableControlAction(0,23,true)DisableControlAction(0,24,true)DisableControlAction(0,25,true)DisableControlAction(0,47,true)DisableControlAction(0,58,true)DisableControlAction(0,75,true)DisableControlAction(0,140,true)DisableControlAction(0,141,true)DisableControlAction(0,142,true)DisableControlAction(0,143,true)DisableControlAction(0,257,true)DisableControlAction(0,263,true)DisableControlAction(0,264,true)end;local function E(F,z)if F.team=="civilian"then SetVehicleColours(z,64,64)else SetVehicleColours(z,29,29)end;if b.state~="START"then FreezeEntityPosition(z,true)else if F.team=="civilian"then FreezeEntityPosition(z,false)else if GetGameTimer()-b.startTime>20000 then FreezeEntityPosition(z,false)else FreezeEntityPosition(z,true)end end end;local y=PlayerPedId()SetEntityProofs(y,true,true,true,true,true,true,true,true)SetEntityInvincible(y)SetVehicleEngineOn(z,true,true,false)end;local function G(H,I)return HasEntityBeenDamagedByEntity(H,I,true)or HasEntityBeenDamagedByEntity(I,H,true)or IsEntityTouchingEntity(H,I)or IsEntityTouchingEntity(I,H)end;local function J(k)if not k.lastCaptured then return true else return GetGameTimer()-k.lastCaptured>1000 end end;local function K(k,L)if k.team~="civilian"or not J(k)then return end;local x=GetPlayerFromServerId(k.source)if x==-1 then return end;local y=GetPlayerPed(x)if y==0 then return end;local z=GetVehiclePedIsUsing(y)if z==0 then return end;if not G(z,L)then return end;ClearEntityLastDamageEntity(z)ClearEntityLastDamageEntity(L)TriggerServerEvent("CMG:manhuntCapturedPlayer",k.source)k.lastCaptured=GetGameTimer()end;local function M(z)for j,k in pairs(currentEvent.players)do K(k,z)end end;local function N(F,O)if not b.countdownScaleform then b.countdownScaleform=RequestScaleformMovie("mp_big_message_freemode")elseif not HasScaleformMovieLoaded(b.countdownScaleform)then return end;local P=20-math.floor(O/1000)BeginScaleformMovieMethod(b.countdownScaleform,"SHOW_SHARD_WASTED_MP_MESSAGE")if F.team=="hunter"then ScaleformMovieMethodAddParamTextureNameString("~r~YOU ARE A HUNTER")ScaleformMovieMethodAddParamTextureNameString(string.format("Chase begins in %d seconds",P))else ScaleformMovieMethodAddParamTextureNameString("~r~GET READY")ScaleformMovieMethodAddParamTextureNameString(string.format("Hunters released in %d seconds",P))end;ScaleformMovieMethodAddParamInt(7)EndScaleformMovieMethod()DrawScaleformMovieFullscreen(b.countdownScaleform,255,255,255,255)end;local function Q(F)SetScaleformMovieAsNoLongerNeeded(b.countdownScaleform)b.countdownScaleform=nil;if F.team=="civilian"then notify("The hunters have now been released, be on the lookout!")else notify("The chase begins, you can now hunt people down!")end end;local function R(F)if F.team=="civilian"then local S=g("hunter")>1 and"hunters"or"hunter"drawNativeText(string.format("Escape the ~r~%s~w~",S))else drawNativeText("You are a ~r~hunter~w~. Hit a player to kill them")end end;local function T(U)local V=math.floor(U/60)if V>0 then return string.format("%02d:%02d",V,U-V*60)else return string.format("%02d",U)end end;local function W(F)if b.winnerFound then return end;c.reset()local O=GetGameTimer()-b.startTime;if O<20000 then N(F,O)elseif b.countdownScaleform then Q(F)else R(F)end;c.push("~b~CIVILIANS~w~",g("civilian"))c.push("~r~HUNTERS~w~",g("hunter"))local X=a.gameTime-math.floor((GetGameTimer()-b.startTime)/1000)if X<0 then X=0 end;c.push("~y~TIME LEFT~w~",T(X))c.draw()end;local function Y()if table.count(b)==0 then return end;local F=CMG.getEventLocalPlayer()if not F then return end;local y=PlayerPedId()local z=GetVehiclePedIsUsing(y)if z~=0 then E(F,z)end;D()if b.state=="START"then SetPlayerControl(PlayerId(),true,0)W(F)if z~=0 then M(z)end end end;local function Z()CMG.enableEventPlayerBlips(false)CMG.enableEventPlayerTags(false,false)CMG.setPlayerCanOpenLeaderboard(false)CMG.cleanupRockstarMaps()TriggerMusicEvent("BST_STOP")b={}end;Citizen.CreateThread(function()for _,a0 in pairs(a.locations)do local a1=nil;CMG.registerEventMenuItem("Manhunt",_,function()if not currentEvent.isActive then RageUI.Separator("Minimum Players: "..tostring(a.minPlayers))RageUI.Separator("Maximum Players: "..tostring(#a0.spawnpoints.civilians))local a2={RightLabel=not a1 and"~y~DEFAULT"or a1}RageUI.ButtonWithStyle("Vehicle Selection","Enter a specific vehicle to use or leave empty to use default.",a2,true,function(a3,a4,a5)if a5 then CMG.clientPrompt("Enter Spawncode","",function(a6)a1=#a6>=3 and string.upper(a6)or nil end)end end)RageUI.ButtonWithStyle("Start Event",nil,{RightLabel="→→→"},true,function(a3,a4,a5)if a5 then TriggerServerEvent("CMG:startEvent","Manhunt",_,a.minPlayers,#a0.spawnpoints.civilians,{customSpawncode=a1})end end)end end)CMG.registerEventCleanupHandler(_,Z)end;CMG.createThreadOnTick(Y)end)